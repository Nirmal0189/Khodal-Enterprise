<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Khodal Enterprise - Inventory Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <style>
    :root {
      --bg: #0a0f1a;
      --panel: #0f172a;
      --muted: #1e293b;
      --card: #0f172a;
      --text: #f1f5f9;
      --sub: #94a3b8;
      --brand: #06b6d4;
      --accent: #8b5cf6;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow: 0 20px 40px rgba(0,0,0,0.4);
      --shadow-lg: 0 25px 50px rgba(0,0,0,0.5);
      --radius: 16px;
      --radius-lg: 24px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --gradient: linear-gradient(135deg, var(--brand), var(--accent));
      --gradient-subtle: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(139, 92, 246, 0.1));
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Helvetica, Arial, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, var(--bg) 0%, #0f172a 50%, #1e293b 100%);
      color: var(--text);
      font-size: 15px;
      line-height: 1.7;
      overflow-x: hidden;
      font-weight: 400;
    }
    
    a {
      color: inherit;
      text-decoration: none;
    }
    
    /* Login Page Styles */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--bg) 0%, #0f172a 50%, #1e293b 100%);
      position: relative;
    }
    
    .login-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(34,211,238,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }
    
    .login-card {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-lg);
      padding: 48px;
      width: 100%;
      max-width: 480px;
      box-shadow: var(--shadow-lg);
      animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    
    .login-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient);
    }
    
    .login-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 80%, rgba(34, 211, 238, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(167, 139, 250, 0.1) 0%, transparent 50%);
      pointer-events: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .login-logo {
      text-align: center;
      margin-bottom: 35px;
      position: relative;
      z-index: 2;
    }
    
    .login-logo img {
      width: 90px;
      height: 90px;
      border-radius: 20px;
      object-fit: cover;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      border: 2px solid rgba(34, 211, 238, 0.2);
      transition: var(--transition);
    }
    
    .login-logo img:hover {
      transform: scale(1.05);
      border-color: rgba(34, 211, 238, 0.4);
    }
    
    .login-logo h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 700;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .login-logo p {
      color: var(--sub);
      font-size: 16px;
      font-weight: 500;
    }
    
    .login-form .control {
      margin-bottom: 24px;
      position: relative;
      z-index: 2;
    }
    
    .login-form label {
      display: block;
      margin-bottom: 10px;
      color: var(--sub);
      font-weight: 600;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .login-form .control:focus-within label {
      color: var(--brand);
    }
    
    .password-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .password-container input {
      flex: 1;
      padding-right: 50px;
    }
    
    .toggle-password {
      position: absolute;
      right: 12px;
      background: none;
      border: none;
      color: var(--sub);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: var(--transition);
    }
    
    .toggle-password:hover {
      color: var(--brand);
      background: rgba(34, 211, 238, 0.1);
    }
    
    .login-form input {
      width: 100%;
      padding: 18px 20px;
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      color: var(--text);
      font-size: 16px;
      transition: var(--transition);
      font-weight: 500;
      backdrop-filter: blur(10px);
    }
    
    .login-form input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.25);
      outline: none;
      background: rgba(15, 23, 42, 0.9);
      transform: translateY(-2px);
    }
    
    .login-form input::placeholder {
      color: var(--sub);
      opacity: 0.7;
    }
    
    /* Password strength indicators */
    .login-form input[style*="border-color: var(--good)"] {
      border-color: var(--good) !important;
      box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.2);
    }
    
    .login-form input[style*="border-color: var(--bad)"] {
      border-color: var(--bad) !important;
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.2);
    }
    
    .login-btn {
      width: 100%;
      padding: 18px 24px;
      background: var(--gradient);
      border: none;
      border-radius: 16px;
      color: white;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 20px;
      position: relative;
      overflow: hidden;
      z-index: 2;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
    }
    
    .login-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .login-btn:hover::before {
      left: 100%;
    }
    
    .login-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 35px rgba(6, 182, 212, 0.5);
    }
    
    .login-btn:active {
      transform: translateY(-1px);
    }
    
    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .login-links {
      text-align: center;
      margin-top: 25px;
      font-size: 15px;
      color: var(--sub);
      position: relative;
      z-index: 2;
    }
    
    .login-links a {
      color: var(--brand);
      font-weight: 600;
      transition: var(--transition);
      padding: 4px 8px;
      border-radius: 6px;
    }
    
    .login-links a:hover {
      background: rgba(34, 211, 238, 0.1);
      color: var(--text);
    }
    
    .login-error {
      background: rgba(248, 113, 113, 0.15);
      border: 1px solid rgba(248, 113, 113, 0.4);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 25px;
      color: var(--bad);
      font-size: 14px;
      display: none;
      animation: shake 0.5s ease;
      position: relative;
      z-index: 2;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .login-error i {
      margin-right: 8px;
      color: var(--bad);
    }
    
    .loading {
      position: relative;
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Loading indicator for main app */
    .loading-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      color: var(--sub);
      background: rgba(17, 24, 39, 0.8);
      border-radius: var(--radius);
      margin: 20px;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(34, 211, 238, 0.2);
      border-top: 3px solid var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-indicator p {
      font-size: 16px;
      font-weight: 500;
      margin: 0;
    }
    
    /* App Styles */
    .app {
      display: none; /* Hidden until login */
      flex-direction: column;
      min-height: 100vh;
    }
    
    .app.show {
      display: flex !important;
    }
    
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 28px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }
    
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      overflow: hidden;
      transition: var(--transition);
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .logo:hover {
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .logo img {
      max-width: 110%;
      max-height: 100%;
      border-radius: 12px;
      object-fit: cover;
    }
    
    .brand-text h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 800;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.025em;
    }
    
    .muted {
      color: var(--sub);
      font-size: 13px;
    }
    
    /* Main content layout */
    .main-container {
      display: flex;
      flex: 1;
      position: relative;
    }
    
    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      transition: var(--transition);
      width: 100%;
    }
    
    /* Panel and controls */
    .panel {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 24px;
      backdrop-filter: blur(15px);
    }
    
    .controls {
      display: grid;
      gap: 20px;
    }
    
    .control {
      display: grid;
      gap: 8px;
    }
    
    label {
      font-size: 13px;
      color: var(--sub);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    label i {
      color: var(--brand);
    }
    
    input, select, button, textarea {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: var(--text);
      padding: 14px 16px;
      border-radius: 14px;
      outline: none;
      font-family: inherit;
      font-size: 14px;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
      background: rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }
    
    /* Buttons */
    button {
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .btn {
      padding: 14px 18px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-weight: 600;
      letter-spacing: 0.025em;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.3);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .btn.primary {
      background: linear-gradient(180deg, rgba(34, 211, 238, 0.2), rgba(34, 211, 238, 0.1));
      border-color: rgba(34, 211, 238, 0.3);
    }
    
    .btn.brand {
      background: var(--gradient);
      border: 1px solid rgba(6, 182, 212, 0.5);
      color: white;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
    }
    
    .btn.warn {
      background: linear-gradient(180deg, rgba(245,158,11,.2), rgba(245,158,11,.08));
      border: 1px solid rgba(245,158,11,.5);
    }
    
    .btn.bad {
      background: linear-gradient(180deg, rgba(248,113,113,.2), rgba(248,113,113,.08));
      border: 1px solid rgba(248,113,113,.5);
    }
    
    .btn-sm {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
    }
    
    /* Topbar and search */
    .topbar {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(15px);
    }
    
    .topbar h2 {
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 24px;
      font-weight: 700;
    }
    
    .searchbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .search-wrapper {
      position: relative;
      flex: 1;
      min-width: 240px;
      transition: var(--transition);
    }
    
    .search-wrapper:focus-within {
      transform: scale(1.02);
    }
    
    .search-wrapper i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--sub);
      z-index: 1;
    }
    
    .search-wrapper input {
      width: 100%;
      padding-left: 40px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .search-wrapper input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
      transform: translateY(-1px);
    }
    
    .search-wrapper input:not(:placeholder-shown) {
      background: rgba(6, 182, 212, 0.1);
      border-color: var(--brand);
    }
    
    .search-status {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--brand);
      background: rgba(6, 182, 212, 0.1);
      padding: 4px 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    
    .clear-search-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 10px;
    }
    
    .clear-search-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-50%) scale(1.1);
    }
    
    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .stat {
      padding: 24px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      border: 1px solid rgba(255, 255, 255, 0.12);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(15px);
    }
    
    .stat::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient);
    }
    
    .stat:hover {
      transform: translateY(-2px);
      box-shadow: none;
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .stat h3 {
      margin: 0 0 8px;
      font-size: 14px;
      color: var(--sub);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat h3 i {
      color: var(--brand);
    }
    
    .stat .v {
      font-size: 24px;
      font-weight: 700;
      color: var(--brand);
    }
    
    /* Grid and cards */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    /* Compact density mode */
    body.density-compact .header { padding: 14px 20px; }
    body.density-compact .panel { padding: 16px; margin-bottom: 16px; }
    body.density-compact .controls { gap: 12px; }
    body.density-compact .btn { padding: 10px 12px; }
    body.density-compact .btn-icon { width: 32px; height: 32px; }
    body.density-compact .grid { gap: 12px; }
    body.density-compact .card-body { padding: 12px; }
    body.density-compact .title { font-size: 14px; height: 2.4em; }
    body.density-compact .sub { font-size: 12px; margin-bottom: 6px; }
    body.density-compact .chip { padding: 4px 8px; font-size: 10px; }
    body.density-compact .footer { gap: 6px; }
    body.density-compact .footer .btn { padding: 8px 10px; }
    body.density-compact .table-container { margin: 16px 0; }
    body.density-compact th, body.density-compact td { padding: 10px 12px; }
    
    /* Responsive grid system */
    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 18px;
      }
    }
    
    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
      }
    }
    
    .card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: var(--radius-lg);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      position: relative;
      backdrop-filter: blur(15px);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient);
      opacity: 0;
      transition: var(--transition);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: none;
      border-color: rgba(6, 182, 212, 0.3);
    }
    
    /* Mobile card optimizations */
    @media (max-width: 768px) {
      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }
      
      .card .thumb img:hover {
        transform: scale(1.02);
      }
    }
    
    .thumb {
      aspect-ratio: 1/1;
      background: linear-gradient(135deg, #0c1426, #0a0f1a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }
    
    .card:hover .thumb img {
      transform: scale(1.05);
    }
    
    .card-body {
      padding: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .title {
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      height: 2.8em;
      line-height: 1.4;
    }
    
    .sub {
      font-size: 13px;
      color: var(--sub);
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    
    .row.wrap {
      flex-wrap: wrap;
    }
    
    .chip {
      font-size: 12px;
      color: #e2e8f0;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 6px 12px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }
    
    .chip:hover {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }
    
    .footer {
      display: flex;
      gap: 8px;
      margin-top: auto;
      padding-top: 12px;
      flex-wrap: wrap;
    }
    
    .footer .btn {
      flex: 1;
      min-width: 70px;
      justify-content: center;
      font-size: 10px;
    }
    
    /* Table view */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-lg);
      margin: 24px 0;
      -webkit-overflow-scrolling: touch;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9));
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(15px);
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 600px;
    }
    
    th, td {
      text-align: left;
      padding: 14px 16px;
      white-space: nowrap;
    }
    
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    thead th {
      font-size: 13px;
      color: var(--sub);
      font-weight: 600;
      background: rgba(11, 19, 36, 0.95);
      backdrop-filter: blur(8px);
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    tbody tr {
      background: rgba(11, 19, 36, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }
    
    tbody tr:hover {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(255, 255, 255, 0.15);
      transform: scale(1.01);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    tbody td {
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    tbody td:first-child {
      border-left: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 10px 0 0 10px;
    }
    
    tbody td:last-child {
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0 10px 10px 0;
    }
    
    /* Modals */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.8);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }
    
    @media (max-width: 768px) {
      .modal-backdrop {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
      }
    }
    
    .modal {
      width: min(920px, 96vw);
      max-height: 90vh;
      overflow: auto;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      animation: modalFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(25px);
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(10px);
      z-index: 5;
    }
    
    .modal .body {
      padding: 20px;
    }
    
    /* Empty state */
    .empty {
      padding: 48px 28px;
      color: var(--sub);
      text-align: center;
      border: 2px dashed rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 59, 0.6));
      backdrop-filter: blur(15px);
    }
    
    .empty i {
      font-size: 48px;
      opacity: 0.5;
      color: var(--brand);
    }
    
    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 18px 28px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 14px;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 90vw;
      font-weight: 600;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      border-left: 4px solid var(--good);
    }
    
    .toast.error {
      border-left: 4px solid var(--bad);
    }
    
    .toast.warning {
      border-left: 4px solid var(--warn);
    }
    
    /* Controls section */
    .controls-section {
      margin-bottom: 24px;
    }
    
    
    
    /* Responsive design */
    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
      }
    }
    
    /* Login page responsive */
    @media (max-width: 480px) {
      .login-card {
        padding: 30px 20px;
        margin: 10px;
      }
      
      .login-logo img {
        width: 70px;
        height: 70px;
      }
      
      .login-logo h1 {
        font-size: 24px;
      }
      
      .login-logo p {
        font-size: 14px;
      }
      
      .login-form input {
        padding: 14px;
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .login-btn {
        padding: 14px;
        font-size: 16px;
      }
    }
    
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        padding: 14px 16px;
      }
      
     
      
      /* Mobile-specific card improvements for 2-column layout */
      .card {
        margin-bottom: 0;
      }
      
      .card-body {
        padding: 12px;
      }
      
      .title {
        font-size: 14px;
        height: 2.6em;
        line-height: 1.3;
      }
      
      .sub {
        font-size: 12px;
        margin-bottom: 8px;
        line-height: 1.4;
      }
      
      .chip {
        font-size: 10px;
        padding: 4px 8px;
        margin-bottom: 4px;
      }
      
      .footer {
        justify-content: space-between;
        gap: 4px;
        margin-top: 8px;
      }
      
      .footer .btn {
        flex: 0 0 auto;
        width: 36px;
        height: 36px;
        padding: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 36px;
      }
      
      .footer .btn span {
        display: none;
      }
      
      .footer .btn i {
        margin: 0;
        font-size: 14px;
      }
      
      .content {
        padding: 20px 16px;
        width: 100%;
      }
      
      .topbar {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }
      
      .searchbar {
        flex-direction: column;
        width: 100%;
      }
      
      .search-wrapper {
        min-width: 100%;
      }
      
      .stats {
        grid-template-columns: 1fr 1fr;
      }
      
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .modal {
        width: 98vw;
        max-height: 90vh;
        margin: 0;
        border-radius: 12px;
      }
      
      .modal .body {
        padding: 12px;
        max-height: calc(90vh - 80px);
        overflow-y: auto;
      }
      
      .modal header {
        padding: 12px 16px;
      }
      
      .modal header strong {
        font-size: 16px;
      }
    }
    
    @media (max-width: 640px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .stats {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .stat {
        padding: 12px;
      }
      
      .stat .v {
        font-size: 20px;
      }
    }
    
    @media (max-width: 480px) {
      .btn-text {
        display: none;
      }
      
      .btn-icon {
        width: 42px;
        height: 42px;
      }
      
      .searchbar .btn {
        width: 100%;
        justify-content: center;
      }
      
      .topbar h2 {
        font-size: 1.4rem;
        text-align: center;
      }
      
      .grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      
      .modal .body {
        padding: 12px;
      }
      
      .modal header {
        padding: 12px 16px;
      }
      
      .control {
        width: 100%;
      }
      
      .row.wrap {
        gap: 12px;
      }
      
      .footer .btn {
        width: 32px;
        height: 32px;
      }
      
      .footer .btn i {
        font-size: 12px;
      }
    }
    
    @media (max-width: 360px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .footer {
        gap: 3px;
      }
      
      .footer .btn {
        width: 30px;
        height: 30px;
      }
      
      .footer .btn i {
        font-size: 11px;
      }
      
      .chip {
        font-size: 9px;
        padding: 2px 5px;
      }
    }
    
    @media (max-width: 768px) {
      button, .btn, input[type="button"], input[type="submit"] {
        min-height: 44px;
      }
      
      input, select, textarea {
        font-size: 16px;
      }
      
      .table-container {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
      }
      
      @media (hover: none) {
        .card:hover {
          transform: none;
          box-shadow: none;
        }
        
        .btn:hover {
          transform: none;
          box-shadow: none;
        }
        
        .stat:hover {
          transform: none;
          box-shadow: none;
        }
      }
    }
    
    /* Utility classes */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }
    
    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }
    
    /* Enhanced animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .animate-slide-in {
      animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .animate-fade-in-scale {
      animation: fadeInScale 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }
    
    /* Enhanced focus states */
    .btn:focus,
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.3);
    }
    
    /* Enhanced hover effects */
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: none;
    }
    
    /* Glass morphism effects */
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Enhanced shadows */
    .shadow-lg {
      box-shadow: none;
    }
    
    .shadow-xl {
      box-shadow: none;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--brand);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
    
    /* Selection styles */
    ::selection {
      background: rgba(34, 211, 238, 0.3);
      color: var(--text);
    }
    
    /* Focus visible for accessibility */
    .btn:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--brand);
      outline-offset: 3px;
      border-radius: 4px;
    }
    
    /* Enhanced button states */
    .btn:active {
      transform: translateY(-1px);
      transition: all 0.1s ease;
    }
    
    /* Loading state for buttons */
    .btn.loading {
      position: relative;
      color: transparent;
    }
    
    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    /* Detail Layout */
    .detail-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      align-items: start;
    }
    
    /* Supplier Modal Styles */
    .supplier-list {
      display: grid;
      gap: 16px;
    }
    
    .supplier-item {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .supplier-item:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .supplier-info h4 {
      margin: 0 0 8px 0;
      color: var(--brand);
      font-size: 18px;
      font-weight: 600;
    }
    
    .supplier-info p {
      margin: 0;
      color: var(--sub);
      font-size: 14px;
    }
    
    .supplier-count {
      background: var(--gradient);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .supplier-products {
      display: block;
    }
    
    .supplier-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .supplier-header h3 {
      margin: 0;
      color: var(--text);
      font-size: 20px;
      font-weight: 600;
    }
    
    .supplier-products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    
    .supplier-product-card {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 16px;
      transition: var(--transition);
    }
    
    .supplier-product-card:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .supplier-product-card h4 {
      margin: 0 0 8px 0;
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
    }
    
    .supplier-product-card p {
      margin: 0 0 12px 0;
      color: var(--sub);
      font-size: 14px;
    }
    
    .supplier-product-stats {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    
    .supplier-product-stat {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--sub);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Quick Purchase Form Styles */
    .quick-purchase-form {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .form-section {
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
    }
    
    .form-section h4 {
      margin: 0 0 16px 0;
      color: var(--brand);
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-section h4 i {
      color: var(--brand);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .form-input, .form-select, .form-textarea {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: var(--text);
      padding: 14px 16px;
      border-radius: 14px;
      outline: none;
      font-family: inherit;
      font-size: 14px;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      width: 100%;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
      background: rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-actions {
      display: flex;
      justify-content: center;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .form-actions .btn {
      min-width: 200px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
    }
    
    /* Item Form Styles */
    .item-form {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .item-form .form-section {
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
    }
    
    .item-form .form-section h4 {
      margin: 0 0 16px 0;
      color: var(--brand);
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .item-form .form-section h4 i {
      color: var(--brand);
    }
    
    .item-form .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .item-form .control {
      margin-bottom: 0;
    }
    
    .item-form .control:last-child {
      margin-bottom: 0;
    }
    
    .item-form .form-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .item-form .form-actions .btn {
      min-width: 180px;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
    }
    
    .detail-info-panel {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(15px);
    }
    
    .detail-history-panel {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(15px);
    }
    
    .info-item {
      color: var(--sub);
      font-size: 14px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-item i {
      color: var(--brand);
      width: 16px;
    }
    
    .detail-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .detail-actions .btn {
      flex: 1;
      min-width: 120px;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .history-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .history-header h3 i {
      color: var(--brand);
    }
    
    /* Purchase History Table */
    .purchase-history-table {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .purchase-header {
      display: grid;
      grid-template-columns: 1fr 80px 1fr 80px;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 600;
      color: var(--sub);
      font-size: 13px;
    }
    
    .purchase-row {
      display: grid;
      grid-template-columns: 1fr 80px 1fr 80px;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }
    
    .purchase-row:hover {
      background: rgba(30, 41, 59, 0.3);
    }
    
    .purchase-row:last-child {
      border-bottom: none;
    }
    
    .purchase-col {
      display: flex;
      align-items: center;
      font-size: 14px;
      word-break: break-word;
    }
    
    .purchase-col:first-child {
      font-weight: 600;
      color: var(--brand);
    }
    
    .purchase-col:nth-child(2) {
      justify-content: center;
      font-weight: 600;
    }
    
    .purchase-col:nth-child(3) {
      color: var(--sub);
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .purchase-col:last-child {
      justify-content: center;
    }
    
    /* Mobile Responsive Improvements */
    @media (max-width: 768px) {
      .detail-layout {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .detail-info-panel,
      .detail-history-panel {
        padding: 12px;
      }
      
      .detail-actions {
        flex-direction: column;
        gap: 8px;
      }
      
      .detail-actions .btn {
        min-width: auto;
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .detail-info-panel .thumb {
        margin-bottom: 12px;
      }
      
      .info-item {
        font-size: 14px;
        margin-bottom: 8px;
      }
      
      .history-header {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
        margin-bottom: 12px;
      }
      
      .history-header .btn {
        width: 100%;
        justify-content: center;
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .history-header h3 {
        font-size: 16px;
        margin: 0;
      }
      
      .purchase-header,
      .purchase-row {
        grid-template-columns: 1fr 50px 1fr 50px;
        gap: 6px;
        padding: 8px 10px;
      }
      
      .purchase-col {
        font-size: 12px;
      }
      
      .purchase-col:nth-child(3) {
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .purchase-history-table {
        max-height: 300px;
        overflow-y: auto;
      }
      
      .modal .body {
        padding: 16px;
      }
      
      .row.wrap {
        flex-direction: column;
        gap: 16px;
      }
      
      .control {
        width: 100%;
        min-width: auto !important;
      }
      
      .panel {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .topbar {
        padding: 20px;
        margin-bottom: 24px;
      }
      
      .stats {
        gap: 16px;
        margin: 16px 0;
      }
      
      .stat {
        padding: 20px;
      }
      
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      
      .card {
        margin-bottom: 0;
      }
      
      .footer {
        gap: 6px;
      }
      
      .footer .btn {
        width: 40px;
        height: 40px;
        font-size: 12px;
      }
      
      .btn {
        padding: 12px 16px;
        font-size: 14px;
      }
      
      .btn-sm {
        padding: 8px 10px;
        font-size: 12px;
      }
      
      .search-wrapper {
        min-width: 100%;
      }
      
      .searchbar {
        width: 100%;
        gap: 10px;
        flex-direction: column;
      }
      
      .searchbar .btn {
        flex: 1;
        min-width: auto;
      }
      
      .controls {
        gap: 16px;
      }
      
      .control {
        gap: 6px;
      }
      
      label {
        font-size: 12px;
      }
      
      input, select, textarea {
        padding: 12px 14px;
        font-size: 16px;
      }
      
      /* Hide email on mobile */
      .user-email-mobile {
        display: none;
      }
      

      
      /* 2-column grid for action buttons on mobile */
      .controls .row.wrap {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      .controls .row.wrap .btn {
        width: 100%;
        justify-content: center;
        min-height: 44px;
      }
      

      
      /* Improved header for mobile */
      .header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }
      
      .brand {
        justify-content: center;
      }
      
      .header-actions {
        justify-content: center;
        gap: 12px;
      }
      
      .header-actions #logoutBtn {
        padding: 10px 16px;
        font-size: 14px;
        min-width: auto;
      }
      

      
      /* Remove reset button on mobile */
      .reset-btn-mobile {
        display: none;
      }
      
      /* Supplier modal mobile styles */
      .supplier-products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .supplier-product-card {
        padding: 14px;
      }
      
      .supplier-product-card h4 {
        font-size: 14px;
      }
      
      .supplier-product-card p {
        font-size: 12px;
        margin-bottom: 10px;
      }
      
      .supplier-product-stats {
        gap: 8px;
        margin-top: 10px;
      }
      
      .supplier-product-stat {
        padding: 6px 10px;
        font-size: 11px;
      }
      
      .supplier-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .supplier-header .btn {
        width: 100%;
        justify-content: center;
      }
      
      /* Quick Purchase form mobile styles */
      .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .form-section {
        padding: 16px;
      }
      
      .form-actions .btn {
        min-width: auto;
        width: 100%;
        padding: 14px 20px;
        font-size: 15px;
      }
      
      /* Item form mobile styles */
      .item-form .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .item-form .form-section {
        padding: 16px;
      }
      
      .item-form .form-actions {
        flex-direction: column;
        gap: 12px;
      }
      
      .item-form .form-actions .btn {
        min-width: auto;
        width: 100%;
        padding: 14px 20px;
        font-size: 15px;
      }
    }
    
    @media (max-width: 640px) {
      .detail-layout {
        gap: 16px;
      }
      
      .detail-info-panel,
      .detail-history-panel {
        padding: 14px;
      }
      
      .info-item {
        font-size: 13px;
        margin-bottom: 10px;
      }
      
      .history-header h3 {
        font-size: 16px;
      }
      
      .purchase-header,
      .purchase-row {
        grid-template-columns: 1fr 50px 1fr 50px;
        gap: 6px;
        padding: 8px 10px;
      }
      
      .purchase-col {
        font-size: 12px;
      }
      
      .purchase-col:nth-child(3) {
        max-width: 100px;
      }
      
      .header {
        padding: 16px 20px;
      }
      
      .content {
        padding: 16px 20px;
      }
      
      .panel {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .topbar {
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .stats {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .stat {
        padding: 16px;
      }
      
      .stat .v {
        font-size: 20px;
      }
      
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .card-body {
        padding: 12px;
      }
      
      .title {
        font-size: 14px;
        height: 2.6em;
      }
      
      .sub {
        font-size: 12px;
        margin-bottom: 8px;
      }
      
      .chip {
        font-size: 10px;
        padding: 4px 8px;
      }
      
      .footer .btn {
        width: 36px;
        height: 36px;
        font-size: 11px;
      }
      
      .modal {
        width: 95vw;
        max-height: 90vh;
        margin: 10px;
      }
      
      .modal .body {
        padding: 12px;
      }
      
      .modal header {
        padding: 12px 16px;
      }
      
      .btn {
        padding: 10px 14px;
        font-size: 13px;
      }
      
      .btn-sm {
        padding: 8px 10px;
        font-size: 11px;
      }
      
      /* Form mobile styles for 640px */
      .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .form-section {
        padding: 16px;
      }
      
      .form-actions .btn {
        min-width: auto;
        width: 100%;
        padding: 14px 20px;
        font-size: 15px;
      }
      
      .item-form .form-row {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .item-form .form-section {
        padding: 16px;
      }
      
      .item-form .form-actions {
        flex-direction: column;
        gap: 12px;
      }
      
      .item-form .form-actions .btn {
        min-width: auto;
        width: 100%;
        padding: 14px 20px;
        font-size: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .detail-layout {
        gap: 14px;
      }
      
      .detail-info-panel,
      .detail-history-panel {
        padding: 12px;
      }
      
      .info-item {
        font-size: 12px;
        margin-bottom: 8px;
      }
      
      .detail-actions {
        gap: 8px;
      }
      
      .history-header h3 {
        font-size: 15px;
      }
      
      .purchase-header,
      .purchase-row {
        grid-template-columns: 1fr 40px 1fr 40px;
        gap: 4px;
        padding: 6px 8px;
      }
      
      .purchase-col {
        font-size: 11px;
      }
      
      .purchase-col:nth-child(3) {
        max-width: 80px;
      }
      
      .header {
        padding: 14px 16px;
      }
      
      .content {
        padding: 14px 16px;
      }
      
      .panel {
        padding: 14px;
        margin-bottom: 14px;
      }
      
      .topbar {
        padding: 14px;
        margin-bottom: 18px;
      }
      
      .topbar h2 {
        font-size: 20px;
      }
      
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .card {
        margin-bottom: 0;
      }
      
      .footer {
        gap: 4px;
      }
      
      .footer .btn {
        width: 32px;
        height: 32px;
        font-size: 10px;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .btn-sm {
        padding: 6px 8px;
        font-size: 10px;
      }
      
      .searchbar {
        flex-direction: column;
        gap: 8px;
      }
      
      .searchbar .btn {
        width: 100%;
        justify-content: center;
      }
      
      .controls {
        gap: 12px;
      }
      
      .control {
        gap: 4px;
      }
      
      label {
        font-size: 11px;
      }
      
      input, select, textarea {
        padding: 10px 12px;
        font-size: 16px;
      }
      
      .modal {
        width: 98vw;
        max-height: 95vh;
        margin: 5px;
      }
      
      .modal .body {
        padding: 10px;
      }
      
      .modal header {
        padding: 10px 14px;
      }
      
      .login-card {
        padding: 30px 20px;
        margin: 10px;
      }
      
      .login-logo img {
        width: 70px;
        height: 70px;
      }
      
      .login-logo h1 {
        font-size: 24px;
      }
      
      .login-logo p {
        font-size: 14px;
      }
      
      .login-form input {
        padding: 14px;
        font-size: 16px;
      }
      
      .login-btn {
        padding: 14px;
        font-size: 16px;
      }
      
      /* Form mobile styles for 480px */
      .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .form-section {
        padding: 14px;
      }
      
      .form-actions .btn {
        min-width: auto;
        width: 100%;
        padding: 12px 18px;
        font-size: 14px;
      }
      
      .item-form .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .item-form .form-section {
        padding: 14px;
      }
      
      .item-form .form-actions {
        flex-direction: column;
        gap: 10px;
      }
      
      .item-form .form-actions .btn {
        min-width: auto;
        width: 100%;
        padding: 12px 18px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 360px) {
      .detail-layout {
        gap: 12px;
      }
      
      .detail-info-panel,
      .detail-history-panel {
        padding: 10px;
      }
      
      .info-item {
        font-size: 11px;
        margin-bottom: 6px;
      }
      
      .detail-actions {
        gap: 6px;
      }
      
      .history-header h3 {
        font-size: 14px;
      }
      
      .purchase-header,
      .purchase-row {
        grid-template-columns: 1fr 35px 1fr 35px;
        gap: 3px;
        padding: 5px 6px;
      }
      
      .purchase-col {
        font-size: 10px;
      }
      
      .purchase-col:nth-child(3) {
        max-width: 70px;
      }
      
      .header {
        padding: 12px 14px;
      }
      
      .content {
        padding: 12px 14px;
      }
      
      .panel {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .topbar {
        padding: 12px;
        margin-bottom: 16px;
      }
      
      .topbar h2 {
        font-size: 18px;
      }
      
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      
      .footer .btn {
        width: 28px;
        height: 28px;
        font-size: 9px;
      }
      
      .btn {
        padding: 6px 10px;
        font-size: 11px;
      }
      
      .btn-sm {
        padding: 4px 6px;
        font-size: 9px;
      }
      
      .searchbar {
        gap: 6px;
      }
      
      .controls {
        gap: 10px;
      }
      
      .control {
        gap: 3px;
      }
      
      label {
        font-size: 10px;
      }
      
      input, select, textarea {
        padding: 8px 10px;
        font-size: 16px;
      }
      
      .modal {
        width: 99vw;
        max-height: 98vh;
        margin: 2px;
      }
      
      .modal .body {
        padding: 8px;
      }
      
      .modal header {
        padding: 8px 12px;
      }
      
      /* Form mobile styles for 360px */
      .form-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .form-section {
        padding: 12px;
      }
      
      .form-actions .btn {
        min-width: auto;
        width: 100%;
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .item-form .form-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .item-form .form-section {
        padding: 12px;
      }
      
      .item-form .form-actions {
        flex-direction: column;
        gap: 8px;
      }
      
      .item-form .form-actions .btn {
        min-width: auto;
        width: 100%;
        padding: 10px 16px;
        font-size: 13px;
      }
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .btn, .chip, .card, .stat {
        min-height: 44px;
      }
      
      .footer .btn {
        min-height: 44px;
        min-width: 44px;
      }
      
      .purchase-col:last-child .btn {
        min-height: 36px;
        min-width: 36px;
      }
      
      .search-wrapper input {
        min-height: 44px;
      }
      
      .modal-backdrop {
        padding: 10px;
      }
      
      .modal {
        max-height: 95vh;
      }
    }
    
    /* Mobile-specific optimizations for 2-column layout */
    @media (max-width: 480px) {
      .card {
        min-height: auto;
        touch-action: manipulation;
      }
      
      .thumb {
        aspect-ratio: 1/1;
        min-height: 120px;
        touch-action: manipulation;
      }
      
      .title {
        font-size: 13px;
        height: 2.4em;
        line-height: 1.2;
      }
      
      .sub {
        font-size: 11px;
        margin-bottom: 6px;
        line-height: 1.3;
      }
      
      .chip {
        font-size: 9px;
        padding: 3px 6px;
        margin-bottom: 3px;
      }
      
      .footer {
        gap: 3px;
        margin-top: 6px;
      }
      
      .footer .btn {
        width: 32px;
        height: 32px;
        min-height: 32px;
        min-width: 32px;
        touch-action: manipulation;
      }
      
      .footer .btn i {
        font-size: 12px;
      }
    }
    
    @media (max-width: 360px) {
      .card-body {
        padding: 10px;
      }
      
      .title {
        font-size: 12px;
        height: 2.2em;
      }
      
      .sub {
        font-size: 10px;
        margin-bottom: 5px;
      }
      
      .chip {
        font-size: 8px;
        padding: 2px 5px;
        margin-bottom: 2px;
      }
      
      .footer {
        gap: 2px;
        margin-top: 5px;
      }
      
      .footer .btn {
        width: 28px;
        height: 28px;
        min-height: 28px;
        min-width: 28px;
        touch-action: manipulation;
      }
      
      .footer .btn i {
        font-size: 11px;
      }
      
      /* Ensure 2-column layout works on very small screens */
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      
      .card {
        touch-action: manipulation;
      }
    }
    
    /* 3D Reload Animation Styles */
    .reload-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--bg) 0%, #0f172a 50%, #1e293b 100%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(20px);
    }
    
    .reload-overlay.show {
      display: flex;
      animation: fadeInOverlay 0.5s ease-out;
    }
    
    @keyframes fadeInOverlay {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .reload-container {
      text-align: center;
      position: relative;
    }
    
    .reload-cube {
      width: 80px;
      height: 80px;
      position: relative;
      transform-style: preserve-3d;
      animation: cubeRotate 2s infinite linear;
      margin: 0 auto 30px;
    }
    
    @keyframes cubeRotate {
      0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); }
      100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg); }
    }
    
    .cube-face {
      position: absolute;
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--brand), var(--accent));
      border: 2px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
    }
    
    .cube-face.front { transform: translateZ(40px); }
    .cube-face.back { transform: translateZ(-40px) rotateY(180deg); }
    .cube-face.right { transform: translateX(40px) rotateY(90deg); }
    .cube-face.left { transform: translateX(-40px) rotateY(-90deg); }
    .cube-face.top { transform: translateY(-40px) rotateX(90deg); }
    .cube-face.bottom { transform: translateY(40px) rotateX(-90deg); }
    
    .reload-text {
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .reload-subtext {
      color: var(--sub);
      font-size: 14px;
      opacity: 0.8;
    }
    
    .reload-progress {
      width: 200px;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin: 20px auto 0;
      overflow: hidden;
      position: relative;
    }
    
    .reload-progress-bar {
      height: 100%;
      background: var(--gradient);
      border-radius: 2px;
      width: 0%;
      animation: progressFill 2s ease-in-out infinite;
      position: relative;
    }
    
    .reload-progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes progressFill {
      0% { width: 0%; }
      50% { width: 100%; }
      100% { width: 0%; }
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Floating particles animation */
    .reload-particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--brand);
      border-radius: 50%;
      animation: float 3s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { 
        transform: translateY(0px) translateX(0px) scale(1);
        opacity: 0.3;
      }
      50% { 
        transform: translateY(-20px) translateX(10px) scale(1.2);
        opacity: 1;
      }
    }
    
    .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
    .particle:nth-child(2) { left: 20%; animation-delay: 0.5s; }
    .particle:nth-child(3) { left: 30%; animation-delay: 1s; }
    .particle:nth-child(4) { left: 40%; animation-delay: 1.5s; }
    .particle:nth-child(5) { left: 50%; animation-delay: 2s; }
    .particle:nth-child(6) { left: 60%; animation-delay: 2.5s; }
    .particle:nth-child(7) { left: 70%; animation-delay: 0.3s; }
    .particle:nth-child(8) { left: 80%; animation-delay: 0.8s; }
    .particle:nth-child(9) { left: 90%; animation-delay: 1.3s; }
    .particle:nth-child(10) { left: 95%; animation-delay: 1.8s; }
    
    /* Removed glow effects from reload cube */
    
    /* Removed pulseRing and glowPulse keyframes (glow disabled) */
    
    /* Responsive design for reload animation */
    @media (max-width: 768px) {
      .reload-cube {
        width: 60px;
        height: 60px;
      }
      
      .cube-face {
        width: 60px;
        height: 60px;
        font-size: 18px;
      }
      
      .cube-face.front { transform: translateZ(30px); }
      .cube-face.back { transform: translateZ(-30px) rotateY(180deg); }
      .cube-face.right { transform: translateX(30px) rotateY(90deg); }
      .cube-face.left { transform: translateX(-30px) rotateY(-90deg); }
      .cube-face.top { transform: translateY(-30px) rotateX(90deg); }
      .cube-face.bottom { transform: translateY(30px) rotateX(-90deg); }
      
      .reload-text {
        font-size: 16px;
      }
      
      .reload-subtext {
        font-size: 12px;
      }
      
      .reload-progress {
        width: 150px;
      }
    }
    
    @media (max-width: 480px) {
      .reload-cube {
        width: 50px;
        height: 50px;
      }
      
      .cube-face {
        width: 50px;
        height: 50px;
        font-size: 16px;
      }
      
      .cube-face.front { transform: translateZ(25px); }
      .cube-face.back { transform: translateZ(-25px) rotateY(180deg); }
      .cube-face.right { transform: translateX(25px) rotateY(90deg); }
      .cube-face.left { transform: translateX(-25px) rotateY(-90deg); }
      .cube-face.top { transform: translateY(-25px) rotateX(90deg); }
      .cube-face.bottom { transform: translateY(25px) rotateX(-90deg); }
      
      .reload-text {
        font-size: 14px;
      }
      
      .reload-subtext {
        font-size: 11px;
      }
      
      .reload-progress {
        width: 120px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-container" id="loginPage">
    <div class="login-card">
      <div class="login-logo">
        <img id="loginLogo" src="KHODAL.png" alt="Khodal Enterprise">
        <h1 id="loginTitle">Khodal Enterprise</h1>
        <p>Inventory Management System</p>
      </div>
      
      <div class="login-error hidden" id="loginError">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessage"></span>
      </div>
      
      <form class="login-form" id="loginForm">
        <div class="control">
          <label for="email">
            <i class="fas fa-envelope"></i>
            Email Address
          </label>
          <input type="email" id="email" placeholder="your@email.com" required>
        </div>
        
        <div class="control">
          <label for="password">
            <i class="fas fa-lock"></i>
            Password
          </label>
          <div class="password-container">
            <input type="password" id="password" placeholder="Enter your password" required>
            <button type="button" class="toggle-password" id="togglePassword">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        
        <button type="submit" class="login-btn">
          <i class="fas fa-lock-open"></i> Sign In
        </button>
      </form>
      
      <div class="login-links">
        <p>Don't have an account? <a href="#" id="showRegister">Create Account</a></p>
      </div>
    </div>
  </div>

  <!-- Register Page -->
  <div class="login-container hidden" id="registerPage">
    <div class="login-card">
      <div class="login-logo">
        <img id="registerLogo" src="KHODAL.png" alt="Khodal Enterprise">
        <h1 id="registerTitle">Create Account</h1>
        <p id="registerSubtitle">Join Khodal Enterprise</p>
      </div>
      
      <div class="login-error hidden" id="registerError">
        <i class="fas fa-exclamation-circle"></i>
        <span id="registerErrorMessage"></span>
      </div>
      
      <form class="login-form" id="registerForm">
        <div class="control">
          <label for="regEmail">
            <i class="fas fa-envelope"></i>
            Email Address
          </label>
          <input type="email" id="regEmail" placeholder="your@email.com" required>
        </div>
        
        <div class="control">
          <label for="regPassword">
            <i class="fas fa-lock"></i>
            Password
          </label>
          <div class="password-container">
            <input type="password" id="regPassword" placeholder="Create a password" minlength="6" required>
            <button type="button" class="toggle-password" id="toggleRegPassword">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        
        <div class="control">
          <label for="regPasswordConfirm">
            <i class="fas fa-check-circle"></i>
            Confirm Password
          </label>
          <div class="password-container">
            <input type="password" id="regPasswordConfirm" placeholder="Confirm your password" required>
            <button type="button" class="toggle-password" id="toggleRegPasswordConfirm">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        
        <button type="submit" class="login-btn">
          <i class="fas fa-user-plus"></i> Create Account
        </button>
      </form>
      
      <div class="login-links">
        <p>Already have an account? <a href="#" id="showLogin">Sign In</a></p>
      </div>
    </div>
  </div>

  <!-- 3D Reload Overlay -->
  <div class="reload-overlay" id="reloadOverlay">
    <div class="reload-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>
    <div class="reload-container">
      <div class="reload-cube">
        <div class="cube-face front"><i class="fas fa-cube"></i></div>
        <div class="cube-face back"><i class="fas fa-cube"></i></div>
        <div class="cube-face right"><i class="fas fa-cube"></i></div>
        <div class="cube-face left"><i class="fas fa-cube"></i></div>
        <div class="cube-face top"><i class="fas fa-cube"></i></div>
        <div class="cube-face bottom"><i class="fas fa-cube"></i></div>
      </div>
      <div class="reload-text">Reloading System</div>
      <div class="reload-subtext">Please wait while we refresh your session</div>
      <div class="reload-progress">
        <div class="reload-progress-bar"></div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app" id="app">
    <header class="header">
      <div class="brand">
        <div class="logo">
          <img id="dashboardLogo" src="KHODAL.png" alt="Khodal Enterprise">
        </div>
        <div class="brand-text">
          <h1 id="dashboardName">Khodal Enterprise</h1>
          <div class="muted">Inventory Management System</div>
        </div>
      </div>
      
      <div class="header-actions" style="display: flex; align-items: center; gap: 15px;">
        <span class="muted user-email-mobile" id="userEmail"></span>
        <button class="btn" id="profileBtn">
          <i class="fas fa-user"></i>
          
        </button>
        <button class="btn bad" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          
        </button>
      </div>
      
      
    </header>
    
    <!-- Loading indicator -->
    <div id="loadingIndicator" class="loading-indicator hidden">
      <div class="loading-spinner"></div>
      <p>Loading your inventory...</p>
    </div>

    <div class="main-container">
      <main class="content">
        <div class="controls-section">
          <div class="panel controls">
            <div class="control">
              <label for="q">
                <i class="fas fa-search"></i>
                Search Products
              </label>
              <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input id="q" type="search" placeholder="Search by name, SKU, or supplier..." />
                <button id="clearSearch" class="clear-search-btn" style="display: none;" onclick="clearSearch()">
                  <i class="fas fa-times"></i>
                </button>
                <div id="searchStatus" class="search-status" style="display: none;">
                  <i class="fas fa-spinner fa-spin"></i>
                  <span>Searching...</span>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="control" style="flex:1">
                <label for="sortBy">
                  <i class="fas fa-sort"></i>
                  Sort By
                </label>
                <select id="sortBy">
                  <option value="name">Name (A–Z)</option>
                  <option value="recent">Recently Purchased</option>
                  <option value="qty">Total Qty (High→Low)</option>
                  <option value="created">Recently Added</option>
                </select>
              </div>
              <div class="control" style="width:130px">
                <label for="viewMode">
                  <i class="fas fa-th-large"></i>
                  View Mode
                </label>
                <select id="viewMode">
                  <option value="grid">Grid View</option>
                  <option value="table">Table View</option>
                </select>
              </div>
            </div>
            
            <div class="row wrap">
              <button class="btn brand" id="addItemBtn">
                <i class="fas fa-plus"></i>
                <span>Add Item</span>
              </button>
              <button class="btn" id="importBtn">
                <i class="fas fa-file-import"></i>
                <span>Import</span>
              </button>
              <button class="btn" id="exportBtn">
                <i class="fas fa-file-export"></i>
                <span>Export</span>
              </button>
              <button class="btn warn" id="bulkAddBtn">
                <i class="fas fa-copy"></i>
                <span>Bulk Add</span>
              </button>
              <button class="btn bad reset-btn-mobile" id="resetBtn">
                <i class="fas fa-trash"></i>
                <span>Reset</span>
              </button>
            </div>
            
            <p class="muted" style="font-size:12px;margin:8px 0 0">
              <i class="fas fa-lightbulb"></i> 
              Tip: Photos are saved in the cloud. 200 items is fine, but for larger photos, keep a JSON backup.
            </p>
          </div>
        </div>

        <div class="topbar">
          <h2>Your Products</h2>
          <div class="searchbar">
            <button class="btn brand" id="quickPurchaseBtn">
              <i class="fas fa-bolt"></i>
              <span>Quick Purchase</span>
            </button>
            <button class="btn bad" id="returnBtn">
              <i class="fas fa-undo"></i>
              <span>Return Product</span>
            </button>
            <button class="btn" id="returnsPageBtn">
              <i class="fas fa-clipboard-list"></i>
              <span>Returns</span>
            </button>
            <button class="btn" id="supplierBtn">
              <i class="fas fa-truck"></i>
              <span>Suppliers</span>
            </button>
            <button class="btn" id="statsBtn">
              <i class="fas fa-chart-bar"></i>
              <span>View Stats</span>
            </button>
           </div>
        </div>

        <section class="stats" id="stats">
          <div class="stat">
            <h3><i class="fas fa-cube"></i> Total Products</h3>
            <div class="v" id="statProducts">0</div>
          </div>
          <div class="stat">
            <h3><i class="fas fa-layer-group"></i> Total Quantity</h3>
            <div class="v" id="statQty">0</div>
          </div>
          <div class="stat">
            <h3><i class="fas fa-arrow-up"></i> Purchased Qty</h3>
            <div class="v" id="statPurchasedQty">0</div>
          </div>
          <div class="stat">
            <h3><i class="fas fa-arrow-down"></i> Returned Qty</h3>
            <div class="v" id="statReturnedQty">0</div>
          </div>
          <div class="stat">
            <h3><i class="fas fa-calendar-alt"></i> Last Purchase</h3>
            <div class="v" id="statLast">–</div>
          </div>
          <div class="stat">
            <h3><i class="fas fa-truck"></i> Suppliers</h3>
            <div class="v" id="statSuppliers">0</div>
          </div>
          <div class="stat">
            <h3><i class="fas fa-rupee-sign"></i> Total Rupees</h3>
            <div class="v" id="statAmount">₹0.00</div>
          </div>
        </section>

        <div id="list" class="grid"></div>
        
        <div id="tableWrap" class="hidden">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Photo</th>
                  <th>Name</th>
                  <th>SKU</th>
                  <th>Supplier</th>
                  <th>Total Qty</th>
                  <th>Last Purchase</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
        
        <div id="emptyState" class="empty hidden">
          <i class="fas fa-box-open"></i>
          <h3>No products found</h3>
          <p>Add your first product to get started</p>
          <button class="btn brand" id="addFirstItemBtn">
            <i class="fas fa-plus"></i>
            Add Your First Item
          </button>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal: Add / Edit Item -->
  <div class="modal-backdrop" id="itemModalWrap">
    <div class="modal">
      <header>
        <strong id="itemModalTitle">
          <i class="fas fa-cube"></i> Add Item
        </strong>
        <button class="btn" onclick="closeItemModal()">
          <i class="fas fa-times"></i> Close
        </button>
      </header>
      <div class="body">
        <div class="item-form">
          <div class="form-section">
            <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
            <div class="form-row">
              <div class="control">
                <label for="f_name"><i class="fas fa-tag"></i> Item Name</label>
                <input id="f_name" placeholder="Example: SS Bowl 12cm" class="form-input" />
              </div>
              <div class="control">
                <label for="f_sku"><i class="fas fa-barcode"></i> SKU / Code</label>
                <input id="f_sku" placeholder="BW-12" class="form-input" />
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <h4><i class="fas fa-truck"></i> Supplier & Category</h4>
            <div class="form-row">
              <div class="control">
                <label for="f_supplier"><i class="fas fa-truck"></i> Supplier</label>
                <input id="f_supplier" placeholder="ABC Metals" class="form-input" />
              </div>
              <div class="control">
                <label for="f_category"><i class="fas fa-folder"></i> Category</label>
                <input id="f_category" placeholder="Kitchen" class="form-input" />
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <h4><i class="fas fa-boxes"></i> Quantity & Photo</h4>
            <div class="form-row">
              <div class="control">
                <label for="f_openQty"><i class="fas fa-box-open"></i> Opening Qty</label>
                <input id="f_openQty" type="number" min="0" value="0" class="form-input" />
              </div>
              <div class="control">
                <label for="f_unit"><i class="fas fa-balance-scale"></i> Unit</label>
                <input id="f_unit" placeholder="pcs" value="pcs" class="form-input" />
              </div>
            </div>
            <div class="form-row">
              <div class="control">
                <label for="f_price"><i class="fas fa-rupee-sign"></i> Price (₹)</label>
                <input id="f_price" type="number" min="0" step="0.01" placeholder="0.00" class="form-input" />
              </div>
              <div class="control"></div>
            </div>
            <div class="control">
              <label for="f_photo"><i class="fas fa-camera"></i> Photo</label>
              <input id="f_photo" type="file" accept="image/*" class="form-input" />
            </div>
          </div>
          
          <div class="form-actions">
            <button class="btn brand" id="saveItemBtn">
              <i class="fas fa-save"></i> Save Item
            </button>
            <button class="btn" id="saveItemAddMoreBtn">
              <i class="fas fa-save"></i> Save & Add Another
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Product Detail -->
  <div class="modal-backdrop" id="detailModalWrap">
    <div class="modal">
      <header>
        <strong id="detailTitle">
          <i class="fas fa-info-circle"></i> Item Details
        </strong>
        <button class="btn" onclick="closeDetail()">
          <i class="fas fa-times"></i> Close
        </button>
      </header>
      <div class="body" id="detailBody"></div>
    </div>
  </div>

  <!-- Modal: Quick Purchase -->
  <div class="modal-backdrop" id="purchaseModalWrap">
    <div class="modal">
      <header>
        <strong><i class="fas fa-shopping-cart"></i> Quick Purchase</strong>
        <button class="btn" onclick="closePurchase()">
          <i class="fas fa-times"></i> Close
        </button>
      </header>
      <div class="body">
        <div class="quick-purchase-form">
          <div class="form-section">
            <h4><i class="fas fa-cube"></i> Product Selection</h4>
            <div class="control">
              <label for="p_item">Choose Item</label>
              <select id="p_item" class="form-select"></select>
            </div>
          </div>
          
          <div class="form-section">
            <h4><i class="fas fa-info-circle"></i> Purchase Details</h4>
            <div class="form-row">
              <div class="control">
                <label for="p_qty">Quantity</label>
                <input id="p_qty" type="number" min="1" value="1" class="form-input" />
              </div>
              <div class="control">
                <label for="p_date">Purchase Date</label>
                <input id="p_date" type="date" class="form-input" />
              </div>
            </div>
            <div class="form-row">
              <div class="control">
                <label for="p_amount">Amount (₹)</label>
                <input id="p_amount" type="number" min="0" step="0.01" placeholder="0.00" class="form-input" />
              </div>
              <div class="control"></div>
            </div>
            <div class="control">
              <label for="p_note">Notes (Optional)</label>
              <textarea id="p_note" placeholder="Add any additional notes about this purchase..." class="form-textarea"></textarea>
            </div>
          </div>
          
          <div class="form-actions">
            <button class="btn brand" id="p_save">
              <i class="fas fa-check"></i> Add Purchase
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Return Product -->
  <div class="modal-backdrop" id="returnModalWrap">
    <div class="modal">
      <header>
        <strong><i class="fas fa-undo"></i> Return Product</strong>
        <button class="btn" onclick="closeReturn()">
          <i class="fas fa-times"></i> Close
        </button>
      </header>
      <div class="body">
        <div class="quick-purchase-form">
          <div class="form-section">
            <h4><i class="fas fa-cube"></i> Product Selection</h4>
            <div class="control">
              <label for="r_item">Choose Item</label>
              <select id="r_item" class="form-select"></select>
            </div>
          </div>
          <div class="form-section">
            <h4><i class="fas fa-info-circle"></i> Return Details</h4>
            <div class="form-row">
              <div class="control">
                <label for="r_qty">Quantity</label>
                <input id="r_qty" type="number" min="1" value="1" class="form-input" />
              </div>
              <div class="control">
                <label for="r_date">Return Date</label>
                <input id="r_date" type="date" class="form-input" />
              </div>
            </div>
            <div class="form-row">
              <div class="control">
                <label for="r_amount">Amount (₹)</label>
                <input id="r_amount" type="number" min="0" step="0.01" placeholder="0.00" class="form-input" />
              </div>
              <div class="control"></div>
            </div>
            <div class="control">
              <label for="r_note">Notes (Optional)</label>
              <textarea id="r_note" placeholder="Reason for return..." class="form-textarea"></textarea>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn bad" id="r_save">
              <i class="fas fa-check"></i> Add Return
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Suppliers -->
  <div class="modal-backdrop" id="supplierModalWrap">
    <div class="modal">
      <header>
        <strong><i class="fas fa-truck"></i> Suppliers</strong>
        <button class="btn" onclick="closeSupplier()">
          <i class="fas fa-times"></i> Close
        </button>
      </header>
      <div class="body">
        <div id="supplierList" class="supplier-list">
          <!-- Supplier list will be populated here -->
        </div>
        <div id="supplierProducts" class="supplier-products hidden">
          <div class="supplier-header">
            <button class="btn" onclick="showSupplierList()">
              <i class="fas fa-arrow-left"></i> Back to Suppliers
            </button>
            <h3 id="currentSupplierName">Supplier Products</h3>
          </div>
          <div id="supplierProductsList" class="supplier-products-grid">
            <!-- Products will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Returns Page -->
  <div class="modal-backdrop" id="returnsModalWrap">
    <div class="modal">
      <header>
        <strong><i class="fas fa-clipboard-list"></i> Returns</strong>
        <button class="btn" onclick="closeReturns()">
          <i class="fas fa-times"></i> Close
        </button>
      </header>
      <div class="body">
        <div class="purchase-history-table">
          <div class="purchase-header" style="display:grid;grid-template-columns: 1fr 80px 120px 1fr 120px; align-items:center;">
            <div class="purchase-col">Date</div>
            <div class="purchase-col">Qty</div>
            <div class="purchase-col">Amount (₹)</div>
            <div class="purchase-col">Notes</div>
            <div class="purchase-col">Action</div>
          </div>
          <div id="returnsRows"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Edit Purchase -->
  <div class="modal-backdrop" id="editPurchaseModalWrap">
    <div class="modal">
      <header>
        <strong><i class="fas fa-edit"></i> Edit Purchase</strong>
        <button class="btn" onclick="closeEditPurchase()">
          <i class="fas fa-times"></i> Close
        </button>
      </header>
      <div class="body">
        <div class="quick-purchase-form">
          <div class="form-section">
            <h4><i class="fas fa-cube"></i> Product</h4>
            <div class="form-row">
              <div class="control">
                <label for="ep_item">Choose Item</label>
                <select id="ep_item" class="form-select"></select>
              </div>
              <div class="control">
                <label>&nbsp;</label>
                <button class="btn" id="ep_edit_item_btn"><i class="fas fa-pen"></i> Edit Item</button>
              </div>
            </div>
          </div>
          <div class="form-section">
            <h4><i class="fas fa-info-circle"></i> Edit Details</h4>
            <div class="form-row">
              <div class="control">
                <label for="ep_qty">Quantity</label>
                <input id="ep_qty" type="number" min="1" value="1" class="form-input" />
              </div>
              <div class="control">
                <label for="ep_date">Date</label>
                <input id="ep_date" type="date" class="form-input" />
              </div>
            </div>
            <div class="form-row">
              <div class="control">
                <label for="ep_amount">Amount (₹)</label>
                <input id="ep_amount" type="number" min="0" step="0.01" placeholder="0.00" class="form-input" />
              </div>
              <div class="control"></div>
            </div>
            <div class="control">
              <label for="ep_note">Notes (Optional)</label>
              <textarea id="ep_note" class="form-textarea"></textarea>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn brand" id="ep_save"><i class="fas fa-save"></i> Save Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="importFile" class="hidden" accept="application/json" />
  
  <div id="toast" class="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage"></span>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBU2QzQUSnL1xHACRziKBKgHaBqaFN5mwk",
      authDomain: "khodal-enterprise-1b07d.firebaseapp.com",
      projectId: "khodal-enterprise-1b07d",
      storageBucket: "khodal-enterprise-1b07d.firebasestorage.app",
      messagingSenderId: "905787790243",
      appId: "1:905787790243:web:2c6696bdf26244a6950016",
      measurementId: "G-DTGLD2ZJP0"
    };
    
    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      console.log('✅ Firebase initialized successfully');
    } catch (error) {
      console.error('❌ Firebase initialization error:', error);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    // Authentication state observer with improved session handling
    let authStateInitialized = false;
    
    auth.onAuthStateChanged(async (user) => {
      console.log('🔄 Auth state changed:', user ? 'User signed in' : 'User signed out');
      
      if (user) {
        // User is signed in
        console.log('✅ User signed in:', user.email);
        console.log('🆔 User UID:', user.uid);
        
        try {
          // Update user's last login time
          await db.collection('users').doc(user.uid).update({
            lastLogin: new Date()
          });
          console.log('✅ User profile updated');
        } catch (error) {
          console.log('⚠️ User profile not found, creating new one');
          try {
            await db.collection('users').doc(user.uid).set({
              email: user.email,
              createdAt: new Date(),
              lastLogin: new Date()
            });
            console.log('✅ New user profile created');
          } catch (profileError) {
            console.error('❌ Failed to create user profile:', profileError);
          }
        }
        
        // Show app immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            console.log('🔄 DOM ready, showing app...');
            showApp();
            loadData();
          });
        } else {
          // DOM is already ready
          console.log('🔄 DOM ready, showing app...');
          showApp();
          loadData();
        }
        
        authStateInitialized = true;
        
      } else {
        // User is signed out
        console.log('👋 User signed out');
        
        // Only show login if auth state has been initialized
        // This prevents showing login during initial page load
        if (authStateInitialized) {
          showLogin();
        } else {
          // Wait a bit longer for Firebase to restore session
          setTimeout(() => {
            if (!auth.currentUser) {
              console.log('⏰ No session restored, showing login...');
              showLogin();
              authStateInitialized = true;
            }
          }, 2000); // Wait 2 seconds for session restoration
        }
      }
    });
    
    // Set up Firebase persistence to remember user session
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => {
        console.log('✅ Firebase persistence set to LOCAL');
      })
      .catch((error) => {
        console.error('❌ Error setting Firebase persistence:', error);
      });
    
    // UI Elements for login/register
    const loginPage = document.getElementById('loginPage');
    const registerPage = document.getElementById('registerPage');
    const app = document.getElementById('app');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const showRegisterLink = document.getElementById('showRegister');
    const showLoginLink = document.getElementById('showLogin');
    const loginError = document.getElementById('loginError');
    const errorMessage = document.getElementById('errorMessage');
    const registerError = document.getElementById('registerError');
    const registerErrorMessage = document.getElementById('registerErrorMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');
    
    // Show/hide functions for auth UI
    function showLogin() {
      loginPage.classList.remove('hidden');
      registerPage.classList.add('hidden');
      app.classList.remove('show');
    }
    
    function showRegister() {
      loginPage.classList.add('hidden');
      registerPage.classList.remove('hidden');
      app.classList.remove('show');
    }
    
    function showApp() {
      loginPage.classList.add('hidden');
      registerPage.classList.add('hidden');
      app.classList.add('show');
      userEmail.textContent = auth.currentUser.email;
      
      // Initialize DOM elements if not already done
      if (!listEl) {
        initializeDOMElements();
      }
      
      // Show loading indicator initially
      const loadingIndicator = document.getElementById('loadingIndicator');
      if (loadingIndicator) {
        loadingIndicator.classList.remove('hidden');
      }
      
      console.log('✅ Dashboard displayed successfully');
    }
    
    // Login form submission
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = loginForm.querySelector('.login-btn');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      // Basic validation
      if (!email || !password) {
        showLoginError('Please fill in all fields');
        return;
      }
      
      if (!email.includes('@')) {
        showLoginError('Please enter a valid email address');
        return;
      }
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        hideLoginError();
        showToast('Login successful!', 'success');
      } catch (error) {
        console.error('Login error:', error);
        let errorMsg = 'Login failed. Please try again.';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMsg = 'No account found with this email address.';
            break;
          case 'auth/wrong-password':
            errorMsg = 'Incorrect password. Please try again.';
            break;
          case 'auth/invalid-email':
            errorMsg = 'Invalid email address format.';
            break;
          case 'auth/too-many-requests':
            errorMsg = 'Too many failed attempts. Please try again later.';
            break;
          case 'auth/user-disabled':
            errorMsg = 'This account has been disabled.';
            break;
        }
        
        showLoginError(errorMsg);
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.innerHTML = '<i class="fas fa-lock-open"></i> Sign In';
      }
    });
    
    // Register form submission
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = registerForm.querySelector('.login-btn');
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regPasswordConfirm').value;
      
      // Validation
      if (!email || !password || !confirmPassword) {
        showRegisterError('Please fill in all fields');
        return;
      }
      
      if (!email.includes('@')) {
        showRegisterError('Please enter a valid email address');
        return;
      }
      
      if (password.length < 6) {
        showRegisterError('Password must be at least 6 characters long');
        return;
      }
      
      if (password !== confirmPassword) {
        showRegisterError('Passwords do not match');
        return;
      }
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
      
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        hideRegisterError();
        showToast('Account created successfully!', 'success');
        
        // Create user profile in Firestore
        const user = auth.currentUser;
        if (user) {
          await db.collection('users').doc(user.uid).set({
            email: user.email,
            createdAt: new Date(),
            lastLogin: new Date()
          });
        }
      } catch (error) {
        console.error('Registration error:', error);
        let errorMsg = 'Registration failed. Please try again.';
        
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMsg = 'An account with this email already exists.';
            break;
          case 'auth/invalid-email':
            errorMsg = 'Invalid email address format.';
            break;
          case 'auth/weak-password':
            errorMsg = 'Password is too weak. Please choose a stronger password.';
            break;
          case 'auth/operation-not-allowed':
            errorMsg = 'Registration is currently disabled.';
            break;
        }
        
        showRegisterError(errorMsg);
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
      }
    });
    
    // Helper functions for showing/hiding errors
    function showLoginError(message) {
      errorMessage.textContent = message;
      loginError.style.display = 'block';
      loginError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function hideLoginError() {
      loginError.style.display = 'none';
    }
    
    function showRegisterError(message) {
      registerErrorMessage.textContent = message;
      registerError.style.display = 'block';
      registerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function hideRegisterError() {
      registerError.style.display = 'none';
    }
    
    // Navigation between login and register
    showRegisterLink.addEventListener('click', (e) => {
      e.preventDefault();
      showRegister();
    });
    
    showLoginLink.addEventListener('click', (e) => {
      e.preventDefault();
      showLogin();
    });
    
    // Logout functionality
    logoutBtn.addEventListener('click', async () => {
      try {
        logoutBtn.disabled = true;
        logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing Out...';
        
        await auth.signOut();
        showToast('Logged out successfully', 'success');
        showLogin();
      } catch (error) {
        console.error('Logout error:', error);
        showToast('Error during logout', 'error');
      } finally {
        logoutBtn.disabled = false;
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
      }
    });
    
    // Password toggle functionality
    document.querySelectorAll('.toggle-password').forEach(button => {
      button.addEventListener('click', function() {
        const input = this.previousElementSibling;
        const icon = this.querySelector('i');
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
          icon.title = 'Hide password';
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
          icon.title = 'Show password';
        }
      });
    });
    
    // Cloud Database Functions
    const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    const fmtDate = (d)=> new Date(d).toLocaleDateString('en-IN',{year:'numeric',month:'short',day:'2-digit'});
    
    let state = {items: [], purchases: []};
    
    // Load data from Firestore
    async function loadData() {
      if (!auth.currentUser) {
        console.error('No authenticated user');
        return;
      }
      
      const userId = auth.currentUser.uid;
      console.log('Loading data for user:', userId);
      
      try {
        showToast('Loading your data...', 'warning');
        
        // Check if user document exists first
        const userDoc = await db.collection('users').doc(userId).get();
        if (!userDoc.exists) {
          console.log('Creating new user profile...');
          await db.collection('users').doc(userId).set({
            email: auth.currentUser.email,
            createdAt: new Date(),
            lastLogin: new Date()
          });
        }

        // Apply brand settings to dashboard and auth screens if available
        try {
          const brandData = (await db.collection('users').doc(userId).get()).data() || {};
          const name = brandData.brandName || 'Khodal Enterprise';
          const logo = brandData.brandLogo || 'KHODAL.png';
          const nameEl = document.getElementById('dashboardName');
          const logoEl = document.getElementById('dashboardLogo');
          if (nameEl) nameEl.textContent = name;
          if (logoEl && logo) logoEl.src = logo;
          const loginTitle = document.getElementById('loginTitle'); if (loginTitle) loginTitle.textContent = name;
          const registerSubtitle = document.getElementById('registerSubtitle'); if (registerSubtitle) registerSubtitle.textContent = `Join ${name}`;
          const loginLogo = document.getElementById('loginLogo'); if (loginLogo && logo) loginLogo.src = logo;
          const registerLogo = document.getElementById('registerLogo'); if (registerLogo && logo) registerLogo.src = logo;
          try { localStorage.setItem('brandName', name); localStorage.setItem('brandLogo', logo); } catch(_e) {}
        } catch(brandErr){ console.warn('Brand read failed', brandErr); }
        
        // Load items
        console.log('Loading items...');
        const itemsSnapshot = await db.collection('users').doc(userId).collection('items').get();
        state.items = [];
        itemsSnapshot.forEach((doc) => {
          state.items.push({id: doc.id, ...doc.data()});
        });
        console.log('Loaded items:', state.items.length);
        
        // Load purchases
        console.log('Loading purchases...');
        const purchasesSnapshot = await db.collection('users').doc(userId).collection('purchases').get();
        state.purchases = [];
        purchasesSnapshot.forEach((doc) => {
          state.purchases.push({id: doc.id, ...doc.data()});
        });
        console.log('Loaded purchases:', state.purchases.length);
        
        // Ensure DOM elements are ready before rendering
        if (!listEl || !tableWrap || !tableBody || !emptyState) {
          console.log('🔄 DOM elements not ready, initializing...');
          initializeDOMElements();
        }
        
        // Double-check DOM elements are ready
        if (!listEl || !tableWrap || !tableBody || !emptyState) {
          console.error('❌ DOM elements still not ready after initialization');
          showToast('Dashboard not ready. Please refresh the page.', 'error');
          return;
        }
        
        console.log('✅ DOM elements ready, rendering dashboard...');
        render();
        showToast(`Loaded ${state.items.length} items and ${state.purchases.length} purchases`, 'success');
        
      } catch (error) {
        console.error("Error loading data: ", error);
        console.error("Error details:", error.code, error.message);
        showToast('Error loading data. Please refresh the page.', 'error');
        
        // Show empty state if data loading fails
        state.items = [];
        state.purchases = [];
        render();
      } finally {
        // Hide loading indicator
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
          loadingIndicator.classList.add('hidden');
        }
      }
    }
    
    // Save data to Firestore
    function saveItemToCloud(item) {
      const userId = auth.currentUser.uid;
      const itemRef = db.collection('users').doc(userId).collection('items').doc(item.id);
      
      return itemRef.set(item)
        .then(() => {
          console.log("Item successfully saved!");
          return true;
        })
        .catch((error) => {
          console.error("Error saving item: ", error);
          showToast('Error saving item', 'error');
          return false;
        });
    }
    
    function savePurchaseToCloud(purchase) {
      const userId = auth.currentUser.uid;
      const purchaseRef = db.collection('users').doc(userId).collection('purchases').doc(purchase.id);
      
      return purchaseRef.set(purchase)
        .then(() => {
          console.log("Purchase successfully saved!");
          return true;
        })
        .catch((error) => {
          console.error("Error saving purchase: ", error);
          showToast('Error saving purchase', 'error');
          return false;
        });
    }
    
    function deleteItemFromCloud(itemId) {
      const userId = auth.currentUser.uid;
      
      // First delete all purchases for this item
      const purchasePromises = state.purchases
        .filter(p => p.itemId === itemId)
        .map(p => 
          db.collection('users').doc(userId).collection('purchases').doc(p.id).delete()
        );
      
      // Then delete the item itself
      return Promise.all(purchasePromises)
        .then(() => {
          return db.collection('users').doc(userId).collection('items').doc(itemId).delete();
        })
        .then(() => {
          console.log("Item and its purchases successfully deleted!");
          return true;
        })
        .catch((error) => {
          console.error("Error deleting item: ", error);
          showToast('Error deleting item', 'error');
          return false;
        });
    }
    
    function deletePurchaseFromCloud(purchaseId) {
      const userId = auth.currentUser.uid;
      
      return db.collection('users').doc(userId).collection('purchases').doc(purchaseId).delete()
        .then(() => {
          console.log("Purchase successfully deleted!");
          return true;
        })
        .catch((error) => {
          console.error("Error deleting purchase: ", error);
          showToast('Error deleting purchase', 'error');
          return false;
        });
    }
    
    // Elements - will be initialized when DOM is ready
    let listEl, tableWrap, tableBody, statProducts, statQty, statLast, statSuppliers, emptyState, statAmount, statPurchasedQty, statReturnedQty;
    let q, sortBy, viewMode;
    let itemModalWrap, itemModalTitle, f_name, f_sku, f_supplier, f_category, f_openQty, f_unit, f_price, f_photo;
    let detailModalWrap, detailTitle, detailBody;
    let purchaseModalWrap, p_item, p_qty, p_date, p_note;
    let supplierModalWrap;
    let editingId = null;

    // Initialize DOM elements when they're ready
    function initializeDOMElements() {
      listEl = document.getElementById('list');
      tableWrap = document.getElementById('tableWrap');
      tableBody = document.getElementById('tableBody');
      statProducts = document.getElementById('statProducts');
      statQty = document.getElementById('statQty');
      statPurchasedQty = document.getElementById('statPurchasedQty');
      statReturnedQty = document.getElementById('statReturnedQty');
      statLast = document.getElementById('statLast');
      statSuppliers = document.getElementById('statSuppliers');
      statAmount = document.getElementById('statAmount');
      emptyState = document.getElementById('emptyState');

      // Search & Sort
      q = document.getElementById('q');
      sortBy = document.getElementById('sortBy');
      viewMode = document.getElementById('viewMode');

      // Modals
      itemModalWrap = document.getElementById('itemModalWrap');
      itemModalTitle = document.getElementById('itemModalTitle');
      f_name = document.getElementById('f_name');
      f_sku = document.getElementById('f_sku');
      f_supplier = document.getElementById('f_supplier');
      f_category = document.getElementById('f_category');
      f_openQty = document.getElementById('f_openQty');
      f_unit = document.getElementById('f_unit');
      f_price = document.getElementById('f_price');
      f_photo = document.getElementById('f_photo');

      detailModalWrap = document.getElementById('detailModalWrap');
      detailTitle = document.getElementById('detailTitle');
      detailBody = document.getElementById('detailBody');

      purchaseModalWrap = document.getElementById('purchaseModalWrap');
      p_item = document.getElementById('p_item');
      p_qty = document.getElementById('p_qty');
      p_date = document.getElementById('p_date');
      p_note = document.getElementById('p_note');

      supplierModalWrap = document.getElementById('supplierModalWrap');

      console.log('✅ DOM elements initialized');
      
      // Set up event listeners after DOM elements are ready
      setupEventListeners();
    }

    // Initialize DOM elements when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Apply brand from localStorage on first paint (before auth)
      try {
        const lsName = localStorage.getItem('brandName');
        const lsLogo = localStorage.getItem('brandLogo');
        if (lsName) {
          const loginTitle = document.getElementById('loginTitle'); if (loginTitle) loginTitle.textContent = lsName;
          const registerSubtitle = document.getElementById('registerSubtitle'); if (registerSubtitle) registerSubtitle.textContent = `Join ${lsName}`;
          const dashboardName = document.getElementById('dashboardName'); if (dashboardName) dashboardName.textContent = lsName;
        }
        if (lsLogo) {
          const loginLogo = document.getElementById('loginLogo'); if (loginLogo) loginLogo.src = lsLogo;
          const registerLogo = document.getElementById('registerLogo'); if (registerLogo) registerLogo.src = lsLogo;
          const dashboardLogo = document.getElementById('dashboardLogo'); if (dashboardLogo) dashboardLogo.src = lsLogo;
        }
      } catch(_e) {}
      console.log('🔄 DOM loaded, initializing elements...');
      initializeDOMElements();
      
      // If user is already logged in, ensure dashboard is ready
      if (auth.currentUser) {
        console.log('🔄 User already logged in, ensuring dashboard is ready...');
        setTimeout(() => {
          if (!listEl || !tableWrap || !tableBody || !emptyState) {
            console.log('🔄 Re-initializing DOM elements...');
            initializeDOMElements();
          }
        }, 500);
      }
      
      // Add a fallback to ensure dashboard is visible
      setTimeout(() => {
        const appElement = document.getElementById('app');
        if (appElement && appElement.classList.contains('show')) {
          console.log('🔄 Dashboard is visible, ensuring content is loaded...');
          if (!listEl || !tableWrap || !tableBody || !emptyState) {
            console.log('🔄 Final DOM element initialization...');
            initializeDOMElements();
          }
        }
      }, 1000);
    });

    // UI Enhancements
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const icon = toast.querySelector('i');
      
      toastMessage.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type, 'show');
      
      // Set appropriate icon
      if (type === 'success') {
        icon.className = 'fas fa-check-circle';
      } else if (type === 'error') {
        icon.className = 'fas fa-exclamation-circle';
      } else if (type === 'warning') {
        icon.className = 'fas fa-exclamation-triangle';
      }
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Helpers
    function calcTotals(){
      // Check if DOM elements are ready
      if (!statProducts || !statQty || !statPurchasedQty || !statReturnedQty || !statLast || !statSuppliers || !statAmount) {
        console.warn('⚠️ Stats elements not ready for calcTotals');
        return;
      }

      const items = state.items;
      const pmap = new Map(items.map(i=>[i.id,0]));
      let lastDate = null; const suppliers = new Set();
      for(const p of state.purchases){
        pmap.set(p.itemId, (pmap.get(p.itemId)||0) + Number(p.qty||0));
        if(!lastDate || new Date(p.date)>new Date(lastDate)) lastDate = p.date;
      }
      items.forEach(i=> suppliers.add((i.supplier||'').trim()));
      statProducts.textContent = String(items.length);
      const totalQty = [...pmap.values()].reduce((a,b)=>a+b,0);
      const purchasedQty = state.purchases.filter(p=>Number(p.qty)>0).reduce((a,p)=>a+Number(p.qty||0),0);
      const returnedQty = state.purchases.filter(p=>Number(p.qty)<0).reduce((a,p)=>a+Math.abs(Number(p.qty||0)),0);
      statQty.textContent = totalQty;
      statPurchasedQty.textContent = purchasedQty;
      statReturnedQty.textContent = returnedQty;
      statLast.textContent = lastDate? fmtDate(lastDate) : '–';
      statSuppliers.textContent = [...suppliers].filter(Boolean).length;
      const totalAmt = state.purchases.reduce((sum,p)=> sum + Number(p.amount||0), 0);
      statAmount.textContent = `₹${Number(totalAmt).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    }

    function itemTotalQty(id){
      return state.purchases.filter(p=>p.itemId===id).reduce((a,b)=>a+Number(b.qty||0),0);
    }

    function lastPurchaseDate(id){
      const ps = state.purchases.filter(p=>p.itemId===id);
      if(ps.length===0) return null;
      return ps.sort((a,b)=> new Date(b.date)-new Date(a.date))[0].date;
    }

    function render(){
      // Check if DOM elements are ready
      if (!listEl || !tableWrap || !tableBody || !emptyState) {
        console.warn('⚠️ DOM elements not ready, retrying in 100ms...');
        setTimeout(render, 100);
        return;
      }

      calcTotals();
      const term = (q.value||'').toLowerCase();
      console.log('🔍 Search term:', term);
      console.log('📦 Total items before filter:', state.items.length);
      
      // Show search status and clear button if there's a search term
      const searchStatus = document.getElementById('searchStatus');
      const clearSearchBtn = document.getElementById('clearSearch');
      
      if (searchStatus) {
        if (term) {
          searchStatus.style.display = 'flex';
        } else {
          searchStatus.style.display = 'none';
        }
      }
      
      if (clearSearchBtn) {
        if (term) {
          clearSearchBtn.style.display = 'flex';
        } else {
          clearSearchBtn.style.display = 'none';
        }
      }
      
      let items = state.items.filter(i=>{
        const blob = `${i.name} ${i.sku||''} ${i.supplier||''} ${i.category||''}`.toLowerCase();
        return blob.includes(term);
      });
      console.log('📦 Items after filter:', items.length);
      const s = sortBy.value;
      items.sort((a,b)=>{
        if(s==='name') return a.name.localeCompare(b.name);
        if(s==='recent') return new Date(lastPurchaseDate(b.id)||0) - new Date(lastPurchaseDate(a.id)||0);
        if(s==='qty') return itemTotalQty(b.id) - itemTotalQty(a.id);
        if(s==='created') return (b.created||0) - (a.created||0);
        return 0;
      });

      // Show empty state if no items
      if (items.length === 0) {
        emptyState.classList.remove('hidden');
        listEl.classList.add('hidden');
        tableWrap.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        
        const vm = viewMode.value;
        if(vm==='grid'){
          tableWrap.classList.add('hidden');
          listEl.classList.remove('hidden');
          listEl.innerHTML = items.map(cardHTML).join('');
        } else {
          listEl.classList.add('hidden');
          tableWrap.classList.remove('hidden');
          tableBody.innerHTML = items.map(rowHTML).join('');
        }
      }
      
      console.log('✅ Dashboard rendered successfully');
    }

    function cardHTML(i){
      const qty = itemTotalQty(i.id);
      const last = lastPurchaseDate(i.id);
      return `<div class="card">
        <div class="thumb">${i.photo?`<img src="${i.photo}" alt="${escapeHtml(i.name)}"/>`:'<i class="fas fa-image"></i> No Photo'}</div>
        <div class="card-body">
          <div class="title">${escapeHtml(i.name)}</div>
          <div class="sub">SKU: ${escapeHtml(i.sku||'-')} • ${escapeHtml(i.unit||'pcs')}</div>
          <div class="row" style="margin-top:8px">
            <span class="chip"><i class="fas fa-layer-group"></i> Qty: ${qty}</span>
            <span class="chip"><i class="fas fa-calendar"></i> ${last? fmtDate(last):'–'}</span>
          </div>
          <div class="footer">
            <button class="btn brand" onclick="openDetail('${i.id}')"><i class="fas fa-eye"></i> <span class="btn-text">Open</span></button>
            <button class="btn" onclick="openPurchaseFor('${i.id}')"><i class="fas fa-cart-plus"></i> <span class="btn-text">Purchase</span></button>
            <button class="btn" onclick="editItem('${i.id}')"><i class="fas fa-edit"></i> <span class="btn-text">Edit</span></button>
            <button class="btn bad" onclick="deleteItem('${i.id}')"><i class="fas fa-trash"></i> <span class="btn-text">Delete</span></button>
          </div>
        </div>
      </div>`
    }

    function rowHTML(i){
      const qty = itemTotalQty(i.id);
      const last = lastPurchaseDate(i.id);
      return `<tr>
        <td>${i.photo?`<img src="${i.photo}" alt="${escapeHtml(i.name)}" style="width:48px;height:48px;object-fit:cover;border-radius:8px"/>`:'–'}</td>
        <td><strong>${escapeHtml(i.name)}</strong><div class="sub">${escapeHtml(i.category||'')}</div></td>
        <td>${escapeHtml(i.sku||'-')}</td>
        <td>${escapeHtml(i.supplier||'-')}</td>
        <td>${qty} ${escapeHtml(i.unit||'')}</td>
        <td>${last? fmtDate(last):'–'}</td>
        <td>
          <button class="btn btn-sm" onclick="openDetail('${i.id}')"><i class="fas fa-eye"></i></button>
          <button class="btn btn-sm" onclick="openPurchaseFor('${i.id}')"><i class="fas fa-cart-plus"></i></button>
          <button class="btn btn-sm" onclick="editItem('${i.id}')"><i class="fas fa-edit"></i></button>
          <button class="btn btn-sm bad" onclick="deleteItem('${i.id}')"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`
    }

    function escapeHtml(str=''){
      return String(str).replace(/[&<>"]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]));
    }

    // Item CRUD
    function openItemModal(editId=null){
      editingId = editId;
      itemModalTitle.textContent = editId? ' Edit Item' : '<i class="fas fa-plus"></i> Add Item';
      if(editId){
        const i = state.items.find(x=>x.id===editId);
        f_name.value=i.name||''; f_sku.value=i.sku||''; f_supplier.value=i.supplier||''; f_category.value=i.category||''; f_openQty.value=i.openQty||0; f_unit.value=i.unit||'pcs'; f_price.value = Number(i.price||0); f_photo.value='';
      } else {
        f_name.value=''; f_sku.value=''; f_supplier.value=''; f_category.value=''; f_openQty.value=0; f_unit.value='pcs'; f_price.value=''; f_photo.value='';
      }
      itemModalWrap.style.display='flex';
    }
    
    function closeItemModal(){ 
      itemModalWrap.style.display='none'; 
    }

    async function fileToBase64(file){
      if(!file) return null;
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej; r.readAsDataURL(file);
      });
    }

    async function saveItem(addAnother=false){
      const name=f_name.value.trim(); if(!name){ showToast('Name is required', 'error'); return; }
      const item = editingId? state.items.find(x=>x.id===editingId) : {id:uid(), created:Date.now()};
      item.name = name; item.sku=f_sku.value.trim(); item.supplier=f_supplier.value.trim(); item.category=f_category.value.trim(); item.unit=f_unit.value.trim()||'pcs'; item.price = Number(f_price && f_price.value ? f_price.value : 0);
      if(!editingId){ item.openQty=Number(f_openQty.value||0); }
      if(f_photo.files && f_photo.files[0]){
        const b64 = await fileToBase64(f_photo.files[0]);
        item.photo = b64;
      }
      
      // Save to cloud instead of localStorage
      const success = await saveItemToCloud(item);
      if (!success) return;
      
      if(editingId){
        state.items = state.items.map(x=> x.id===editingId? item : x);
        showToast('Item updated successfully');
      } else {
        state.items.push(item);
        if(item.openQty>0){ 
          const purchase = {id:uid(), itemId:item.id, qty:Number(item.openQty), date: todayStr(), note:'Opening'};
          const purchaseSuccess = await savePurchaseToCloud(purchase);
          if (purchaseSuccess) {
            state.purchases.push(purchase);
          }
        }
        showToast('Item added successfully');
      }
      
      render();
      if(addAnother){ openItemModal(null); } else { closeItemModal(); }
    }

    function editItem(id){ openItemModal(id); }
    
    async function deleteItem(id){
      if(!confirm('Delete this item and its purchase records?')) return;
      
      const success = await deleteItemFromCloud(id);
      if (!success) return;
      
      state.items = state.items.filter(i=>i.id!==id);
      state.purchases = state.purchases.filter(p=>p.itemId!==id);
      showToast('Item deleted successfully');
      render();
    }

    // Detail & Purchases
    function openDetail(id){
      const i = state.items.find(x=>x.id===id);
      detailTitle.textContent = `${i.name}`;
      const ps = state.purchases.filter(p=>p.itemId===id).sort((a,b)=> new Date(b.date)-new Date(a.date));
      const qty = itemTotalQty(id);
             detailBody.innerHTML = `
         <div class="detail-layout">
           <div class="detail-info-panel">
             <div class="thumb" style="border-radius:12px;overflow:hidden;margin-bottom:16px">${i.photo?`<img src="${i.photo}" alt="${escapeHtml(i.name)}"/>`:'<i class="fas fa-image"></i> No Photo'}</div>
             <div class="info-item"><i class="fas fa-barcode"></i> SKU: ${escapeHtml(i.sku||'-')}</div>
             <div class="info-item"><i class="fas fa-truck"></i> Supplier: ${escapeHtml(i.supplier||'-')}</div>
             <div class="info-item"><i class="fas fa-folder"></i> Category: ${escapeHtml(i.category||'-')}</div>
             <div class="info-item"><i class="fas fa-balance-scale"></i> Unit: ${escapeHtml(i.unit||'pcs')}</div>
             <div class="info-item"><i class="fas fa-rupee-sign"></i> Price: ₹${Number(i.price||0).toLocaleString('en-IN',{minimumFractionDigits:2, maximumFractionDigits:2})}</div>
             <div class="info-item"><i class="fas fa-layer-group"></i> Total Qty: ${qty}</div>
             <div class="detail-actions">
               <button class="btn brand" onclick="openPurchaseFor('${i.id}')"><i class="fas fa-cart-plus"></i> Add Purchase</button>
               
             </div>
           </div>
           <div class="detail-history-panel">
             <div class="history-header">
               <h3><i class="fas fa-history"></i> Purchase History</h3>
               <button class="btn bad" onclick="deleteAllPurchases('${i.id}')"><i class="fas fa-trash"></i> Clear History</button>
             </div>
             ${ps.length?`<div class="purchase-history-table">
               <div class="purchase-header" style="display:grid;grid-template-columns: 1fr 80px 120px 1fr 120px; align-items:center;">
                 <div class="purchase-col">Date</div>
                 <div class="purchase-col">Qty</div>
                 <div class="purchase-col">Amount (₹)</div>
                 <div class="purchase-col">Notes</div>
                 <div class="purchase-col">Action</div>
               </div>
               ${ps.map(p=>`<div class="purchase-row" style=\"display:grid;grid-template-columns: 1fr 80px 120px 1fr 120px; align-items:center;\">
                 <div class="purchase-col">${fmtDate(p.date)}</div>
                 <div class="purchase-col">${p.qty}</div>
                 <div class="purchase-col">₹${Number(p.amount||0).toLocaleString('en-IN',{minimumFractionDigits:2, maximumFractionDigits:2})}</div>
                 <div class="purchase-col">${escapeHtml(p.note||'')}</div>
                 <div class="purchase-col">
                   <button class="btn btn-sm" onclick="openEditPurchase('${p.id}')"><i class="fas fa-edit"></i></button>
                   <button class="btn bad btn-sm" onclick="deletePurchase('${p.id}')">
                     <i class="fas fa-trash"></i>
                   </button>
                 </div>
               </div>`).join('')}
             </div>`: `<div class='empty'><i class="fas fa-history"></i> No purchases yet</div>`}
           </div>
         </div>`;
      detailModalWrap.style.display='flex';
    }
    
    function closeDetail(){ detailModalWrap.style.display='none'; }

    async function deletePurchase(pid){
      // Show confirmation popup
      if (!confirm('Are you sure you want to delete this purchase record?')) return;
      
      const success = await deletePurchaseFromCloud(pid);
      if (!success) return;
      
      state.purchases = state.purchases.filter(p=>p.id!==pid);
      showToast('Purchase record deleted');
      render();
      // refresh detail if open
      const open = detailModalWrap.style.display==='flex';
      if(open){ const id = (detailTitle.textContent && state.items.find(i=>i.name===detailTitle.textContent)?.id); if(id) openDetail(id); }
    }
    
    async function deleteAllPurchases(itemId){
      if(!confirm('Clear all purchases for this item?')) return;
      
      const purchasePromises = state.purchases
        .filter(p => p.itemId === itemId)
        .map(p => deletePurchaseFromCloud(p.id));
      
      await Promise.all(purchasePromises);
      
      state.purchases = state.purchases.filter(p=>p.itemId!==itemId);
      showToast('All purchase records cleared');
      render(); 
      openDetail(itemId);
    }

    // Purchase Modal
    function openPurchase(){
      p_item.innerHTML = state.items.map(i=>`<option value='${i.id}'>${escapeHtml(i.name)} (${escapeHtml(i.sku||'')})</option>`).join('');
      p_date.value = todayStr(); p_qty.value=1; p_note.value='';
      const p_amount = document.getElementById('p_amount'); if(p_amount) p_amount.value='';
      purchaseModalWrap.style.display='flex';
    }
    
    function openPurchaseFor(itemId){ openPurchase(); p_item.value=itemId; }
    function closePurchase(){ purchaseModalWrap.style.display='none'; }
    
    // Return Modal
    let returnModalWrap, r_item, r_qty, r_date, r_note;
    function openReturn(){
      if(!returnModalWrap){
        returnModalWrap = document.getElementById('returnModalWrap');
        r_item = document.getElementById('r_item');
        r_qty = document.getElementById('r_qty');
        r_date = document.getElementById('r_date');
        r_note = document.getElementById('r_note');
      }
      if(!state.items.length){ showToast('No items available to return','warning'); return; }
      r_item.innerHTML = state.items.map(i=>`<option value='${i.id}'>${escapeHtml(i.name)} (${escapeHtml(i.sku||'')})</option>`).join('');
      r_date.value = todayStr(); r_qty.value=1; r_note.value='';
      const r_amount = document.getElementById('r_amount'); if(r_amount) r_amount.value='';
      returnModalWrap.style.display='flex';
    }
    function closeReturn(){ if(returnModalWrap) returnModalWrap.style.display='none'; }
    async function addReturn(){
      if(!r_item || !r_item.value){ showToast('Please choose an item', 'error'); return; }
      const qtyNum = Number(r_qty.value||0);
      if(qtyNum<=0){ showToast('Quantity must be greater than 0', 'error'); return; }
      const amtEl = document.getElementById('r_amount');
      const amountRaw = amtEl ? Number(amtEl.value||0) : 0;
      if(amountRaw<0){ showToast('Amount cannot be negative', 'error'); return; }
      const rec = { id:uid(), itemId:r_item.value, qty:-Math.abs(qtyNum), amount: -Math.abs(Number.isFinite(amountRaw)? amountRaw : 0), date: r_date.value||todayStr(), note: (r_note.value.trim()||'Return') };
      const success = await savePurchaseToCloud(rec);
      if(!success) return;
      state.purchases.push(rec);
      showToast('Return recorded');
      render(); closeReturn();
    }
    
    // Supplier Modal Functions
    function openSupplier(){
      const supplierList = document.getElementById('supplierList');
      const supplierProducts = document.getElementById('supplierProducts');
      
      // Get unique suppliers and their product counts
      const suppliers = new Map();
      state.items.forEach(item => {
        if (item.supplier && item.supplier.trim()) {
          const supplierName = item.supplier.trim();
          if (!suppliers.has(supplierName)) {
            suppliers.set(supplierName, []);
          }
          suppliers.get(supplierName).push(item);
        }
      });
      
      // Create supplier list HTML
      const supplierHTML = Array.from(suppliers.entries()).map(([name, items]) => `
        <div class="supplier-item" onclick="showSupplierProducts('${escapeHtml(name)}')">
          <div class="supplier-info">
            <h4>${escapeHtml(name)}</h4>
            <p>${items.length} product${items.length !== 1 ? 's' : ''}</p>
          </div>
          <div class="supplier-count">
            ${items.length}
          </div>
        </div>
      `).join('');
      
      supplierList.innerHTML = supplierHTML || '<div class="empty"><i class="fas fa-truck"></i> No suppliers found</div>';
      
      // Show supplier list
      supplierList.classList.remove('hidden');
      supplierProducts.classList.add('hidden');
      
      supplierModalWrap.style.display='flex';
    }
    
    function showSupplierProducts(supplierName){
      const supplierList = document.getElementById('supplierList');
      const supplierProducts = document.getElementById('supplierProducts');
      const currentSupplierName = document.getElementById('currentSupplierName');
      const supplierProductsList = document.getElementById('supplierProductsList');
      
      // Get products for this supplier
      const supplierItems = state.items.filter(item => 
        item.supplier && item.supplier.trim() === supplierName
      );
      
      currentSupplierName.textContent = `${supplierName} Products`;
      
      // Create products grid HTML
      const productsHTML = supplierItems.map(item => {
        const qty = itemTotalQty(item.id);
        const last = lastPurchaseDate(item.id);
        return `
          <div class="supplier-product-card">
            <h4>${escapeHtml(item.name)}</h4>
            <p>SKU: ${escapeHtml(item.sku || '-')} • ${escapeHtml(item.category || '-')}</p>
            <div class="supplier-product-stats">
              <span class="supplier-product-stat">
                <i class="fas fa-layer-group"></i> Qty: ${qty}
              </span>
              <span class="supplier-product-stat">
                <i class="fas fa-calendar"></i> ${last ? fmtDate(last) : '–'}
              </span>
            </div>
          </div>
        `;
      }).join('');
      
      supplierProductsList.innerHTML = productsHTML || '<div class="empty"><i class="fas fa-box-open"></i> No products found</div>';
      
      // Show products, hide supplier list
      supplierList.classList.add('hidden');
      supplierProducts.classList.remove('hidden');
    }
    
    function showSupplierList(){
      const supplierList = document.getElementById('supplierList');
      const supplierProducts = document.getElementById('supplierProducts');
      
      supplierList.classList.remove('hidden');
      supplierProducts.classList.add('hidden');
    }
    
    function closeSupplier(){
      supplierModalWrap.style.display='none';
    }

    // Returns Page
    let returnsModalWrap;
    function openReturns(){
      if(!returnsModalWrap){ returnsModalWrap = document.getElementById('returnsModalWrap'); }
      const container = document.getElementById('returnsRows');
      // Collect negative qty purchases
      const returns = state.purchases.filter(p => Number(p.qty) < 0).sort((a,b)=> new Date(b.date)-new Date(a.date));
      if(!returns.length){
        container.innerHTML = `<div class='empty' style='margin:12px'><i class="fas fa-undo"></i> No returns found</div>`;
      } else {
        container.innerHTML = returns.map(p=>{
          const item = state.items.find(i=>i.id===p.itemId);
          const name = item ? item.name : '—';
          return `
            <div class="purchase-row">
              <div class="purchase-col">${escapeHtml(name)}</div>
              <div class="purchase-col">${Math.abs(Number(p.qty||0))}</div>
              <div class="purchase-col">${fmtDate(p.date)}</div>
              <div class="purchase-col">₹${Math.abs(Number(p.amount||0)).toLocaleString('en-IN',{minimumFractionDigits:2, maximumFractionDigits:2})}</div>
              <div class="purchase-col">${escapeHtml(p.note||'')}</div>
              <div class="purchase-col">
                <button class="btn bad btn-sm" onclick="deletePurchase('${p.id}')"><i class="fas fa-trash"></i></button>
              </div>
            </div>`;
        }).join('');
      }
      returnsModalWrap.style.display='flex';
    }
    function closeReturns(){ if(returnsModalWrap) returnsModalWrap.style.display='none'; }

    async function addPurchase(){
      if(!p_item.value){ showToast('Please choose an item', 'error'); return; }
      const amtEl = document.getElementById('p_amount');
      const amount = amtEl ? Number(amtEl.value||0) : 0;
      const rec = { id:uid(), itemId:p_item.value, qty:Number(p_qty.value||0), amount: Number.isFinite(amount)? amount : 0, date: p_date.value||todayStr(), note: p_note.value.trim() };
      if(rec.qty<=0){ showToast('Quantity must be greater than 0', 'error'); return; }
      if(rec.amount<0){ showToast('Amount cannot be negative', 'error'); return; }
      
      const success = await savePurchaseToCloud(rec);
      if (!success) return;
      
      state.purchases.push(rec); 
      showToast('Purchase added successfully');
      render(); closePurchase();
    }

    // Import/Export/Reset
    function exportJSON(){
      const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='khodal-inventory.json'; a.click(); URL.revokeObjectURL(url);
      showToast('Data exported successfully');
    }
    
    function importJSONFile(file){
      const r = new FileReader();
      r.onload=async()=>{ 
        try{ 
          const data = JSON.parse(r.result); 
          if(!data.items||!data.purchases) throw new Error('Invalid format'); 
          
          // Save all items to cloud
          const itemPromises = data.items.map(item => saveItemToCloud(item));
          const purchasePromises = data.purchases.map(purchase => savePurchaseToCloud(purchase));
          
          await Promise.all([...itemPromises, ...purchasePromises]);
          
          state = data;
          render();
          showToast('Data imported successfully');
        }catch(e){ 
          showToast('Invalid JSON file format', 'error'); 
        } 
      };
      r.readAsText(file);
    }
    
    async function resetData(){ 
      if(!confirm('Reset all data? This cannot be undone.')) return;
      
      const userId = auth.currentUser.uid;
      
      // Delete all items
      const itemPromises = state.items.map(item => 
        db.collection('users').doc(userId).collection('items').doc(item.id).delete()
      );
      
      // Delete all purchases
      const purchasePromises = state.purchases.map(purchase => 
        db.collection('users').doc(userId).collection('purchases').doc(purchase.id).delete()
      );
      
      await Promise.all([...itemPromises, ...purchasePromises]);
      
      state={items:[],purchases:[]}; 
      render();
      showToast('All data has been reset');
    }

    // Bulk Add for 200 items (placeholder generator)
    async function bulkAdd(){
      if(!confirm('Create 200 sample products?')) return;
      const base = Date.now();
      
      for(let n=1;n<=200;n++){
        const id=uid();
        const item = {id, name:`SS Item ${n}`, sku:`SS-${String(n).padStart(3,'0')}`, supplier: n%5===0? 'Shree Metals' : n%3===0? 'Om Steel' : 'ABC Steel', category: n%2===0? 'Kitchen':'Industrial', unit:'pcs', created: base - n*10000};
        
        await saveItemToCloud(item);
        state.items.push(item);
        
        // opening qty random
        const oq = Math.floor(Math.random()*5);
        if(oq>0){ 
          const purchase = {id:uid(), itemId:id, qty:oq, date: todayStr(), note:'Opening'};
          await savePurchaseToCloud(purchase);
          state.purchases.push(purchase);
        }
      }
      
      showToast('200 sample products created');
      render();
    }

    // Wire up event listeners
    document.getElementById('addItemBtn').onclick = ()=> openItemModal();
    document.getElementById('saveItemBtn').onclick = ()=> saveItem(false);
    document.getElementById('saveItemAddMoreBtn').onclick = ()=> saveItem(true);
    document.getElementById('addFirstItemBtn').onclick = ()=> openItemModal();

    document.getElementById('quickPurchaseBtn').onclick = openPurchase;
    document.getElementById('supplierBtn').onclick = openSupplier;
    document.getElementById('p_save').onclick = addPurchase;
    document.getElementById('profileBtn').onclick = () => { window.location.href = 'profile.html'; };
    document.getElementById('returnBtn').onclick = openReturn;
    document.getElementById('r_save').onclick = addReturn;
    document.getElementById('returnsPageBtn').onclick = openReturns;

    document.getElementById('importBtn').onclick = ()=> document.getElementById('importFile').click();
    document.getElementById('importFile').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(f) importJSONFile(f); e.target.value=''; });
    document.getElementById('exportBtn').onclick = exportJSON;
    document.getElementById('resetBtn').onclick = resetData;
    document.getElementById('bulkAddBtn').onclick = bulkAdd;
    document.getElementById('statsBtn').onclick = () => {
      const statsSection = document.getElementById('stats');
      statsSection.scrollIntoView({ behavior: 'smooth' });
    };
    
    // Reload button event listener
    const reloadBtn = document.getElementById('reloadBtn');
    if (reloadBtn) {
      reloadBtn.addEventListener('click', () => {
        if (auth.currentUser) {
          showReloadAnimation();
        } else {
          showToast('Please log in first', 'warning');
        }
      });
    }
    
    // Test search functionality
    function testSearchFunctionality() {
      console.log('🧪 Testing search functionality...');
      if (!q) {
        console.error('❌ Search input element not found');
        showToast('Search input not found', 'error');
        return;
      }
      
      if (!q.oninput && !q._listeners) {
        console.error('❌ Search input has no event listeners');
        showToast('Search event listeners not set up', 'error');
        return;
      }
      
      console.log('✅ Search input element found');
      console.log('✅ Search input value:', q.value);
      console.log('✅ Search input placeholder:', q.placeholder);
      
      // Test if render function exists
      if (typeof render === 'function') {
        console.log('✅ Render function exists');
        showToast('Search functionality is working correctly', 'success');
      } else {
        console.error('❌ Render function not found');
        showToast('Render function not found', 'error');
      }
    }
    
    // Test Firebase connection
    document.getElementById('testFirebaseBtn').onclick = async () => {
      try {
        console.log('🧪 Testing Firebase connection...');
        
        if (!auth.currentUser) {
          showToast('No user logged in', 'error');
          return;
        }
        
        const userId = auth.currentUser.uid;
        console.log('Current user ID:', userId);
        
        // Test writing to Firestore
        const testDoc = await db.collection('users').doc(userId).collection('test').doc('connection-test').set({
          timestamp: new Date(),
          message: 'Firebase connection test successful!'
        });
        
        console.log('✅ Write test successful');
        
        // Test reading from Firestore
        const testRead = await db.collection('users').doc(userId).collection('test').doc('connection-test').get();
        
        if (testRead.exists) {
          console.log('✅ Read test successful:', testRead.data());
          showToast('Firebase connection test successful!', 'success');
        } else {
          showToast('Firebase read test failed', 'error');
        }
        
      } catch (error) {
        console.error('❌ Firebase test failed:', error);
        showToast('Firebase test failed: ' + error.message, 'error');
      }
    };

    // Event listeners for search and sorting
    // Debounce function for search
    let searchTimeout;
    function debouncedRender() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(render, 300);
    }
    
    function setupEventListeners() {
      if (q) {
        // Remove any existing listeners to prevent duplicates
        q.removeEventListener('input', debouncedRender);
        q.addEventListener('input', debouncedRender);
        console.log('✅ Search input event listener set up with debounce');
      } else {
        console.warn('⚠️ Search input element not found');
      }
      if (sortBy) {
        sortBy.removeEventListener('change', render);
        sortBy.addEventListener('change', render);
      }
      if (viewMode) {
        viewMode.removeEventListener('change', render);
        viewMode.addEventListener('change', render);
      }
    }
    
    // Set up event listeners after DOM initialization
    setupEventListeners();
    
    // Fallback: Ensure search functionality works even if DOM elements are not ready initially
    setTimeout(() => {
      if (!q) {
        console.log('🔄 Re-attempting search input setup...');
        q = document.getElementById('q');
        if (q) {
          q.removeEventListener('input', debouncedRender);
          q.addEventListener('input', debouncedRender);
          console.log('✅ Search input event listener set up (fallback)');
        }
      }
    }, 1000);

    // Close modals on backdrop click
    [itemModalWrap, detailModalWrap, purchaseModalWrap, supplierModalWrap, document.getElementById('returnModalWrap'), document.getElementById('returnsModalWrap')].forEach(el=> {
      if (el) {
        el.addEventListener('click', (e)=>{ 
          if(e.target===el){ 
            el.style.display='none'; 
          } 
        });
      }
    });

    // Set today's date as default for purchase date
    if (p_date) p_date.value = todayStr();
    
    // Initialize the app
    console.log('🚀 Khodal Enterprise Inventory Management System initialized');
    
    // Add helpful console messages
    console.log('💡 Tips:');
    console.log('- Use Ctrl+N to quickly add new items');
    console.log('- Use Ctrl+F to focus the search bar');
    console.log('- Press Escape to close any open modals');
    console.log('- Your data is automatically saved to Firebase');
    
    // Expose functions to window for onclick handlers
    window.openDetail = openDetail;
    window.closeDetail = closeDetail;
    window.openPurchaseFor = openPurchaseFor;
    window.deletePurchase = deletePurchase;
    window.deleteAllPurchases = deleteAllPurchases;
    window.editItem = editItem;
    window.deleteItem = deleteItem;
    window.closeItemModal = closeItemModal;
    window.closePurchase = closePurchase;
    window.closeSupplier = closeSupplier;
    window.closeReturn = closeReturn;
    window.closeReturns = closeReturns;
    window.showSupplierProducts = showSupplierProducts;
    window.showSupplierList = showSupplierList;
    window.testSearchFunctionality = testSearchFunctionality;
    
    // Clear search function
    function clearSearch() {
      if (q) {
        q.value = '';
        render();
        q.focus();
      }
    }
    window.clearSearch = clearSearch;

    // 3D Reload Animation Functionality
    const reloadOverlay = document.getElementById('reloadOverlay');
    
    // Function to show 3D reload animation
    function showReloadAnimation() {
      console.log('🔄 Starting 3D reload animation...');
      
      // Show the overlay
      reloadOverlay.classList.add('show');
      
      // Add loading state to reload button
      const reloadBtn = document.getElementById('reloadBtn');
      if (reloadBtn) {
        reloadBtn.disabled = true;
        reloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="btn-text">Reloading...</span>';
      }
      
      // Simulate reload process with progress updates
      let progress = 0;
      const progressBar = reloadOverlay.querySelector('.reload-progress-bar');
      const progressInterval = setInterval(() => {
        progress += 2;
        if (progressBar) {
          progressBar.style.width = `${progress}%`;
        }
        if (progress >= 100) {
          clearInterval(progressInterval);
        }
      }, 60); // 3 seconds total = 60ms per 2%
      
      setTimeout(() => {
        console.log('🔄 Reload animation completed, refreshing data...');
        
        // Hide the overlay
        reloadOverlay.classList.remove('show');
        
        // Reset progress bar
        if (progressBar) {
          progressBar.style.width = '0%';
        }
        
        // Reset reload button
        if (reloadBtn) {
          reloadBtn.disabled = false;
          reloadBtn.innerHTML = '<i class="fas fa-sync-alt"></i> <span class="btn-text">Reload</span>';
        }
        
        // Reload data from Firebase
        loadData();
        
        // Show success message
        showToast('System reloaded successfully!', 'success');
        
      }, 3000); // 3 seconds animation duration
    }
    
    // Function to show reload animation and return to login
    function showReloadToLogin() {
      console.log('🔄 Starting 3D reload animation to login...');
      
      // Show the overlay
      reloadOverlay.classList.add('show');
      
      // Update text for login reload
      const reloadText = reloadOverlay.querySelector('.reload-text');
      const reloadSubtext = reloadOverlay.querySelector('.reload-subtext');
      
      if (reloadText) reloadText.textContent = 'Returning to Login';
      if (reloadSubtext) reloadSubtext.textContent = 'Please wait while we redirect you';
      
      // Simulate reload process
      setTimeout(() => {
        console.log('🔄 Reload animation completed, showing login...');
        
        // Hide the overlay
        reloadOverlay.classList.remove('show');
        
        // Reset text
        if (reloadText) reloadText.textContent = 'Reloading System';
        if (reloadSubtext) reloadSubtext.textContent = 'Please wait while we refresh your session';
        
        // Sign out and show login
        auth.signOut().then(() => {
          showLogin();
          showToast('Returned to login screen', 'success');
        }).catch((error) => {
          console.error('Error signing out:', error);
          showToast('Error returning to login', 'error');
        });
        
      }, 3000); // 3 seconds animation duration
    }
    
    // Add keyboard shortcut for reload (Ctrl+R or Cmd+R)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        if (auth.currentUser) {
          showReloadAnimation();
        } else {
          showToast('Please log in first', 'warning');
        }
      }
    });
    
    // Add reload to login functionality (Ctrl+Shift+R or Cmd+Shift+R)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'R' && (e.ctrlKey || e.metaKey) && e.shiftKey) {
        e.preventDefault();
        showReloadToLogin();
      }
    });
    
    // Expose reload functions to window for global access
    window.showReloadAnimation = showReloadAnimation;
    window.showReloadToLogin = showReloadToLogin;
    
    // Add swipe gesture for mobile reload (swipe down from top)
    let touchStartY = 0;
    let touchEndY = 0;
    
    document.addEventListener('touchstart', (e) => {
      touchStartY = e.changedTouches[0].screenY;
    });
    
    document.addEventListener('touchend', (e) => {
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
    });
    
    function handleSwipe() {
      const swipeThreshold = 100;
      const swipeDistance = touchStartY - touchEndY;
      
      // Swipe down from top (pull to refresh style)
      if (swipeDistance > swipeThreshold && touchStartY < 100) {
        if (auth.currentUser) {
          showReloadAnimation();
        } else {
          showToast('Please log in first', 'warning');
        }
      }
    }
    
    // Show initial reload animation on first load (optional)
    let hasShownInitialAnimation = false;
    
    function showInitialAnimation() {
      if (!hasShownInitialAnimation && auth.currentUser) {
        hasShownInitialAnimation = true;
        setTimeout(() => {
          showReloadAnimation();
        }, 1000); // Show after 1 second
      }
    }
    
    // Call initial animation when user is authenticated
    if (auth.currentUser) {
      showInitialAnimation();
    }
    
    // Add context menu for reload options
    document.addEventListener('contextmenu', (e) => {
      // Only show context menu on the app area
      if (e.target.closest('#app')) {
        e.preventDefault();
        
        // Create context menu
        const contextMenu = document.createElement('div');
        contextMenu.style.cssText = `
          position: fixed;
          top: ${e.clientY}px;
          left: ${e.clientX}px;
          background: rgba(15, 23, 42, 0.95);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.12);
          border-radius: 12px;
          padding: 8px;
          z-index: 10000;
          box-shadow: 0 20px 40px rgba(0,0,0,0.4);
          min-width: 200px;
        `;
        
        contextMenu.innerHTML = `
          <div style="padding: 8px 12px; color: var(--text); font-size: 12px; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 4px;">
            <i class="fas fa-sync-alt"></i> Reload Options
          </div>
          <button onclick="showReloadAnimation(); this.closest('.context-menu').remove();" style="width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; color: var(--text); cursor: pointer; border-radius: 6px; transition: all 0.3s ease;">
            <i class="fas fa-sync"></i> Reload System
          </button>
          <button onclick="showReloadToLogin(); this.closest('.context-menu').remove();" style="width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; color: var(--text); cursor: pointer; border-radius: 6px; transition: all 0.3s ease;">
            <i class="fas fa-sign-in-alt"></i> Return to Login
          </button>
        `;
        
        // Add hover effects
        const buttons = contextMenu.querySelectorAll('button');
        buttons.forEach(btn => {
          btn.addEventListener('mouseenter', () => {
            btn.style.background = 'rgba(34, 211, 238, 0.1)';
          });
          btn.addEventListener('mouseleave', () => {
            btn.style.background = 'none';
          });
        });
        
        contextMenu.className = 'context-menu';
        document.body.appendChild(contextMenu);
        
        // Remove context menu when clicking outside
        const removeContextMenu = () => {
          if (contextMenu.parentNode) {
            contextMenu.parentNode.removeChild(contextMenu);
          }
          document.removeEventListener('click', removeContextMenu);
        };
        
        setTimeout(() => {
          document.addEventListener('click', removeContextMenu);
        }, 100);
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown',(e)=>{
      if(e.key==='n' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); openItemModal(); }
      if(e.key==='f' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); if(q) q.focus(); }
      if(e.key==='Escape'){ 
        if(itemModalWrap && itemModalWrap.style.display==='flex') closeItemModal();
        if(detailModalWrap && detailModalWrap.style.display==='flex') closeDetail();
        if(purchaseModalWrap && purchaseModalWrap.style.display==='flex') closePurchase();
        if(supplierModalWrap && supplierModalWrap.style.display==='flex') closeSupplier();
      }
    });

    // Edit Purchase logic
    let editPurchaseModalWrap, ep_item, ep_qty, ep_date, ep_amount, ep_note, editingPurchaseId = null;
    function openEditPurchase(pid){
      console.log('openEditPurchase called with:', pid);
      if(!editPurchaseModalWrap){
        editPurchaseModalWrap = document.getElementById('editPurchaseModalWrap');
        ep_item = document.getElementById('ep_item');
        ep_qty = document.getElementById('ep_qty');
        ep_date = document.getElementById('ep_date');
        ep_amount = document.getElementById('ep_amount');
        ep_note = document.getElementById('ep_note');
      }
      if(!editPurchaseModalWrap){
        console.error('Edit purchase modal not found');
        showToast('Edit modal not found','error');
        return;
      }
      const p = state.purchases.find(x=>x.id===pid);
      if(!p){ showToast('Purchase not found','error'); return; }
      editingPurchaseId = pid;
      // Populate items selector
      if(ep_item){
        ep_item.innerHTML = state.items.map(i=>`<option value='${i.id}'>${escapeHtml(i.name)} (${escapeHtml(i.sku||'')})</option>`).join('');
        ep_item.value = p.itemId;
      }
      ep_qty.value = Math.abs(Number(p.qty||0));
      ep_date.value = p.date || todayStr();
      ep_amount.value = Math.abs(Number(p.amount||0));
      ep_note.value = p.note || '';
      editPurchaseModalWrap.style.display='flex';
      console.log('Edit purchase modal opened');
    }
    function closeEditPurchase(){ if(editPurchaseModalWrap){ editPurchaseModalWrap.style.display='none'; editingPurchaseId=null; } }
    async function saveEditedPurchase(){
      if(!editingPurchaseId) return;
      const pOld = state.purchases.find(x=>x.id===editingPurchaseId);
      if(!pOld) { showToast('Purchase not found','error'); return; }
      const qtyNum = Number(ep_qty.value||0); if(qtyNum<=0){ showToast('Quantity must be greater than 0','error'); return; }
      const amtNum = Number(ep_amount.value||0); if(amtNum<0){ showToast('Amount cannot be negative','error'); return; }
      const updated = {
        ...pOld,
        itemId: ep_item && ep_item.value ? ep_item.value : pOld.itemId,
        qty: pOld.qty<0 ? -Math.abs(qtyNum) : Math.abs(qtyNum),
        amount: pOld.amount<0 ? -Math.abs(amtNum) : Math.abs(amtNum),
        date: ep_date.value || todayStr(),
        note: (ep_note.value||'')
      };
      const userId = auth.currentUser && auth.currentUser.uid;
      try{
        await db.collection('users').doc(userId).collection('purchases').doc(updated.id).set(updated);
        state.purchases = state.purchases.map(x=> x.id===updated.id ? updated : x);
        showToast('Purchase updated');
        render();
        closeEditPurchase();
        const open = detailModalWrap && detailModalWrap.style.display==='flex';
        if(open){ const id = (detailTitle.textContent && state.items.find(i=>i.name===detailTitle.textContent)?.id); if(id) openDetail(id); }
      }catch(e){
        showToast('Failed to update purchase','error');
      }
    }
    window.openEditPurchase = openEditPurchase;
    window.closeEditPurchase = closeEditPurchase;

    // Bindings for edit purchase modal
    const epSaveBtn = document.getElementById('ep_save'); if(epSaveBtn) epSaveBtn.onclick = saveEditedPurchase;
    const epEditItemBtn = document.getElementById('ep_edit_item_btn'); if(epEditItemBtn) epEditItemBtn.onclick = ()=>{ if(ep_item && ep_item.value){ closeEditPurchase(); editItem(ep_item.value); } };

    // Include backdrop close for edit modal as well
    [document.getElementById('editPurchaseModalWrap')].forEach(el=> {
      if (el) {
        el.addEventListener('click', (e)=>{ if(e.target===el){ el.style.display='none'; } });
      }
    });

    // Enhanced click handler for edit buttons
    document.addEventListener('click', (e)=>{
      const btn = e.target && (e.target.closest && e.target.closest('button'));
      if(btn && btn.matches('.purchase-row .btn')){
        const icon = btn.querySelector('i');
        if(icon && icon.classList.contains('fa-edit')){
          console.log('Edit button clicked');
          const row = btn.closest('.purchase-row');
          if(!row) return;
          // Try to find purchase id from inline handler attribute
          const onclickAttr = btn.getAttribute('onclick');
          const idMatch = onclickAttr && onclickAttr.match(/openEditPurchase\('([^']+)'\)/);
          if(idMatch && idMatch[1]){
            console.log('Found purchase ID:', idMatch[1]);
            openEditPurchase(idMatch[1]);
            e.preventDefault();
            e.stopPropagation();
          } else {
            console.error('Could not extract purchase ID from onclick');
          }
        }
      }
    });
  </script>
</body>
</html>